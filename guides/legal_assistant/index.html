
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://datascienceworld-kan.github.io/vinagent/guides/legal_assistant/">
      
      
        <link rel="prev" href="../paper_research/">
      
      
        <link rel="next" href="../customer_care/">
      
      
        
      
      
      <link rel="icon" href="../../asset/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.3">
    
    
      
        <title>Legal Agent - Vinagent</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/navigation_title_ovverides.css">
    
      <link rel="stylesheet" href="../../stylesheets/version_admonitions.css">
    
      <link rel="stylesheet" href="../../stylesheets/sticky_navigation.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  <meta property="og:title" content="Vinagent">
  <meta property="og:description" content="An AI Agent library.">
  <meta property="og:image" content="https://datascienceworld-kan.github.io/vinagent/assets/images/favicon.png">
  <meta property="og:image:alt" content="Vinagent Thumbnail">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://datascienceworld-kan.github.io/vinagent">

  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#legal-assistant-with-vinagent" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Vinagent" class="md-header__button md-logo" aria-label="Vinagent" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Vinagent
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Legal Agent
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/datascienceworld-kan/vinagent" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
    
  
  Get started

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../analyze_stock_trending/" class="md-tabs__link">
          
  
  
    
  
  Guidelines

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../reference/agent/" class="md-tabs__link">
          
  
  
    
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../contributing/contributing/" class="md-tabs__link">
          
  
  
    
  
  Contributing

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Vinagent" class="md-nav__button md-logo" aria-label="Vinagent" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Vinagent
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/datascienceworld-kan/vinagent" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../.." class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    Get started
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Guidelines
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guidelines
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Financial Usercase
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Financial Usercase
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analyze_stock_trending/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Visualize and Analyze Stock
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../trending_news/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Find Trending New
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Banking Agent
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Banking Agent
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../banking_agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Banking SQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Research Usercase
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Research Usercase
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../paper_research/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Research Agent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" checked>
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Legal Field
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Legal Field
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Legal Agent
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Legal Agent
  

    
  </span>
  
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="Table of Content">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of Content
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisite-installation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisite Installation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prepare-data-and-tool" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prepare Data and Tool
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize-legal-agent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialize Legal Agent
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#find-the-relevant-legal-case" class="md-nav__link">
    <span class="md-ellipsis">
      
        Find the relevant legal case
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summarize-legal-case" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summarize legal case
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#timeline-and-fact-organization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Timeline and Fact Organization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#argument-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Argument analysis
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jurisdictional-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Jurisdictional Analysis
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethical-and-bias-in-court-ruling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ethical and Bias in court ruling
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Ecommerce Usercase
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ecommerce Usercase
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../customer_care/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Customer Care Multi-Agent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    RAG
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    RAG
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agent_rag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agent RAG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../reference/agent/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../contributing/contributing/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary" aria-label="Table of Content">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of Content
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisite-installation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisite Installation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prepare-data-and-tool" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prepare Data and Tool
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize-legal-agent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialize Legal Agent
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#find-the-relevant-legal-case" class="md-nav__link">
    <span class="md-ellipsis">
      
        Find the relevant legal case
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summarize-legal-case" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summarize legal case
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#timeline-and-fact-organization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Timeline and Fact Organization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#argument-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Argument analysis
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jurisdictional-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Jurisdictional Analysis
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ethical-and-bias-in-court-ruling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Ethical and Bias in court ruling
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                




  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
      
        
  
  
    
    
      
  
  
    
    
      <li class="md-path__item">
        <a href="../analyze_stock_trending/" class="md-path__link">
          
  <span class="md-ellipsis">
    Guidelines
  </span>

        </a>
      </li>
    
  

    
  

      
        
  
  
    
    
      <li class="md-path__item">
        <a href="./" class="md-path__link">
          
  <span class="md-ellipsis">
    Legal Field
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/datascienceworld-kan/vinagent/edit/main/docs/docs/guides/legal_assistant.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="legal-assistant-with-vinagent">Legal Assistant with vinagent<a class="headerlink" href="#legal-assistant-with-vinagent" title="Permanent link">&para;</a></h1>
<p><a href="https://colab.research.google.com/github/datascienceworld-kan/vinagent/blob/main/docs/docs/tutorials/guides/4.Legal_Assistant.ipynb"><img alt="Open in Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<p>This tutorial demonstrates how to build a comprehensive legal assistant using vinagent that can help attorneys and legal professionals with various tasks including:</p>
<ul>
<li>Finding similar legal cases using semantic and exact-match search</li>
<li>Summarizing legal cases for quick review</li>
<li>Creating timelines of legal events</li>
<li>Analyzing arguments and their strengths/weaknesses</li>
<li>Conducting jurisdictional analysis</li>
<li>Evaluating ethical considerations in court rulings</li>
</ul>
<h2 id="prerequisite-installation">Prerequisite Installation<a class="headerlink" href="#prerequisite-installation" title="Permanent link">&para;</a></h2>
<p>Install the necessary dependencies:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="n">vinagent</span><span class="o">==</span><span class="mf">0.0.4</span><span class="o">.</span><span class="n">post7</span> <span class="n">datasets</span><span class="o">==</span><span class="mf">4.0.0</span>
</span></code></pre></div>
<p>Next, setup environment variables by creating a <code>.env</code> file with your API keys:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>OPENAI_API_KEY=your_openai_api_key
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>TAVILY_API_KEY=your_tavily_api_key
</span></code></pre></div>
<p>You can access <a href="https://platform.openai.com/api-keys">OpenAI</a> site to create a free OpenAI key, which allows to use <code>GPT-4o-mini</code>.</p>
<h2 id="prepare-data-and-tool">Prepare Data and Tool<a class="headerlink" href="#prepare-data-and-tool" title="Permanent link">&para;</a></h2>
<p>Let's download a legal case example dataset from huggingface. This dataset comprises 200 legal cases for <code>test</code> and 7777 legal cases for <code>train</code> datasets. To simplify the demo on local, we only use test dataset.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dataset</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;joelniklaus/legal_case_document_summarization&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">dataset</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="s2">&quot;data/test.parquet&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Creating parquet from Arrow format: 100%|██████████| 1/1 [00:00&lt;00:00,  8.60ba/s]
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">legal_case</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;data/test.parquet&quot;</span><span class="p">)</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="n">legal_case</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>judgement</th>
      <th>dataset_name</th>
      <th>summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Appeal No. 101 of 1959.\nAppeal by special lea...</td>
      <td>IN-Abs</td>
      <td>The appellants who are displaced persons from ...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Appeal No. 52 of 1957.\nAppeal from the judgme...</td>
      <td>IN-Abs</td>
      <td>The appellants and the respondents were owners...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Appeals Nos. 45 and 46 of 1959.\nAppeal by spe...</td>
      <td>IN-Abs</td>
      <td>The respondents firm claimed exemption from Sa...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ION: Criminal Appeal 89 of 1961.\nAppeal by sp...</td>
      <td>IN-Abs</td>
      <td>The appellant was tried for murder.\nThe facts...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Civil Appeal No. 50 of 1961.\nAppeal by specia...</td>
      <td>IN-Abs</td>
      <td>S, employed by the appellant as a cross cutter...</td>
    </tr>
  </tbody>
</table>
</div>

<p>To prepare a knowledge base for legal cases, we transform each row into a document record, which comprises <code>judgement_case, dataset_name, and summary</code>.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.documents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span> <span class="ow">in</span> <span class="n">legal_case</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>        <span class="n">page_content</span><span class="o">=</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;judgement&#39;</span><span class="p">],</span> 
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>            <span class="s2">&quot;judgement_case&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> 
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>            <span class="s2">&quot;dataset_name&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;dataset_name&quot;</span><span class="p">],</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>            <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="p">})</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="n">docs</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>[Document(metadata={&#39;judgement_case&#39;: 0, &#39;dataset_name&#39;: &#39;IN-Abs&#39;, &#39;summary&#39;: &quot;The appellants who are displaced persons from West Pakistan, were granted quasi permanent allotment of some lands in village Raikot in 1949.\nOn October 31, 1952, the Assistant Custodian cancelled the allotment of 14 allottees in village Karodian, and also cancelled the allotment of the Appellants in Raikot but allotted lands to them in village Karodian, and allotted the lands of Raikot to other persons.\nThe 14 allottees of village Karodian as well as the appellants applied for review of the orders of cancellation of their allotment...\n&quot;),
 Document(metadata={&#39;judgement_case&#39;: 1, &#39;dataset_name&#39;: &#39;IN-Abs&#39;, &#39;summary&#39;: &quot;The appellants and the respondents were owners of adjoining collieries and the suit out of which the present appeal arose was one brought by the respondents for certain reliefs on the allegation that the appellants had encroached upon their coal mines and removed coal from the encroached portion and that they came to know of the said encroachment and removal of coal after they had received the letter dated August 18, 1941, from the Inspector of Mines...\n&quot;)]
</code></pre></div>
<p>Next, we organize a vector database by using <code>VectorDatabaseFactory</code> of <code>aucodb</code> library. This class orchestrates every necessary methods like chunking and indexing to create a local vector database. We select <code>milvus</code> as a search engine for this vector database.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_huggingface</span><span class="w"> </span><span class="kn">import</span> <span class="n">HuggingFaceEmbeddings</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aucodb.vectordb.factory</span><span class="w"> </span><span class="kn">import</span> <span class="n">VectorDatabaseFactory</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aucodb.vectordb.processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocumentProcessor</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.text_splitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="c1"># 1. Initialize embedding model</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="n">embedding_model</span> <span class="o">=</span> <span class="n">HuggingFaceEmbeddings</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;BAAI/bge-small-en-v1.5&quot;</span><span class="p">)</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="c1"># 2. Initialize document processor</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>    <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">200</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="p">)</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="n">doc_processor</span> <span class="o">=</span> <span class="n">DocumentProcessor</span><span class="p">(</span><span class="n">splitter</span><span class="o">=</span><span class="n">text_splitter</span><span class="p">)</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="c1"># 3. Initialize vector database factory</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="n">db_type</span> <span class="o">=</span> <span class="s2">&quot;milvus&quot;</span>  <span class="c1"># Supported types: [&#39;chroma&#39;, &#39;faiss&#39;, &#39;milvus&#39;, &#39;pgvector&#39;, &#39;pinecone&#39;, &#39;qdrant&#39;, &#39;weaviate&#39;]</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="n">vectordb_factory</span> <span class="o">=</span> <span class="n">VectorDatabaseFactory</span><span class="p">(</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>    <span class="n">db_type</span><span class="o">=</span><span class="n">db_type</span><span class="p">,</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>    <span class="n">embedding_model</span><span class="o">=</span><span class="n">embedding_model</span><span class="p">,</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>    <span class="n">doc_processor</span><span class="o">=</span><span class="n">doc_processor</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="p">)</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="c1"># 4. Store documents in the vector database</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">store_documents</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
</span></code></pre></div>
<p>Let's test this vector database by a certain query to extract top-5 similar documents.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;claimed exemption from Sales Tax under article 286&quot;</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">top_k</span> <span class="o">=</span> <span class="mi">5</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">retrieved_docs</span> <span class="o">=</span> <span class="n">vectordb_factory</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="p">)</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">retrieved_docs</span><span class="p">):</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Document </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">doc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Document 0: {&#39;text&#39;: &quot;This appeal arises out of the payment of value added tax which was not due, because the supplies in question were exempt...&quot;}
Document 1: {&#39;text&#39;: &quot;This appeal concerns the interpretation of sections 103 and 106 of the Income and Corporation Taxes Act 1988 (ICTA) which...&quot;}
Document 2: {&#39;text&#39;: &quot;This appeal concerns the scope of the duty of confidentiality owed by Her Majestys Revenue and Customs (HMRC) in respect of...&quot;}
Document 3: {&#39;text&#39;: &quot;During the period with which this case is concerned, the claimants (whom we shall refer to as Littlewoods) carried on catalogue sales businesses:...&quot;}
Document 4: {&#39;text&#39;: &quot;This appeal concerns the liability for Value Added Tax (VAT) of a company which markets and arranges holiday accommodation through...&quot;}
</code></pre></div>
<p>Write <code>semantic_search_query</code> function to extract relevant chunks based on the semantic meaning represented by embedding vectors.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">semantic_search_query</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="k">if</span> <span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">vector_store</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Vector store not initialized. Store documents first.&quot;</span><span class="p">)</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="c1"># Generate embedding for query</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>    <span class="n">query_vector</span> <span class="o">=</span> <span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">embedding_model</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>    <span class="c1"># Perform similarity search</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>        <span class="n">collection_name</span><span class="o">=</span><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>        <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">query_vector</span><span class="p">],</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>        <span class="n">limit</span><span class="o">=</span><span class="n">top_k</span><span class="p">,</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>        <span class="n">output_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>        <span class="n">search_params</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>            <span class="s2">&quot;metric_type&quot;</span><span class="p">:</span> <span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">metric_type</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>        <span class="p">},</span>  <span class="c1"># Use consistent metric type</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>    <span class="n">returned_docs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a>    <span class="k">return</span> <span class="n">returned_docs</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="n">results</span> <span class="o">=</span> <span class="n">semantic_search_query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="n">results</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>[(162, 0.7239072918891907),
 (158, 0.7029068470001221),
 (164, 0.6818636059761047),
 (165, 0.680964469909668),
 (144, 0.6737121939659119)]
</code></pre></div>
<p>In another aspect, we need to consider the overlapping percentage of words between the query and the document. This metric serves as an additional score to improve the ability to extract relevant documents, as it can help address the cases where semantic similarity score is usually high for long sentences.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">exact_match_score</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    <span class="c1"># Convert strings to sets of words (case-insensitive, removing punctuation)</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    <span class="n">query_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="n">doc_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="c1"># Calculate intersection of words</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="n">common_words</span> <span class="o">=</span> <span class="n">query_words</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">doc_words</span><span class="p">)</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    <span class="c1"># Avoid division by zero</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc_words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>        <span class="k">return</span> <span class="mf">0.0</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a>    <span class="c1"># Calculate score: 0.5 * (|V_q ∩ V_d|/|V_q| + |V_q ∩ V_d|/|V_d|)</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a>    <span class="n">score</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">common_words</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_words</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_words</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc_words</span><span class="p">))</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a>    <span class="k">return</span> <span class="n">score</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="k">def</span><span class="w"> </span><span class="nf">exact_match_search_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a>    <span class="c1"># Calculate scores for all documents</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>    <span class="n">scores</span> <span class="o">=</span> <span class="p">[(</span><span class="n">id_doc</span><span class="p">,</span> <span class="n">exact_match_score</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">page_content</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">id_doc</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">docs</span><span class="p">)]</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a>    <span class="c1"># Sort by score in descending order</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a>    <span class="n">sorted_scores</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a>    <span class="k">return</span> <span class="n">sorted_scores</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="n">top_k</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">docs</span><span class="p">))]</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="n">exact_match_search_query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">docs</span><span class="o">=</span><span class="n">docs</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>[(2, 0.5056577086280056),
 (87, 0.5027027027027027),
 (53, 0.4397771633051399),
 (162, 0.43877504553734065),
 (194, 0.43830906148867316)]
</code></pre></div>
<p>Next, let's create the SearchLegalEngine class that includes the following functionalities:</p>
<ul>
<li>
<p><code>_create_legal_cases_data</code>: Creates a legal cases dataset, where each document represents a legal record.</p>
</li>
<li>
<p><code>_initialize_document_processor</code>: Creates a vector factory, initializes the vector database, and stores the list of documents.</p>
</li>
<li>
<p><code>exact_match_search_query</code>: Computes a score based on the exact matching percentage of overlapping words between the query and the document.</p>
</li>
<li>
<p><code>semantic_search_query</code>: Retrieves a list of scores based on semantic meaning.</p>
</li>
<li>
<p><code>query_fusion_score</code>: Combines the metrics from exact matching and semantic scores.</p>
</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dataset</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.documents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.text_splitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">SearchLegalEngine</span><span class="p">:</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>            <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>            <span class="n">temp_data_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data/test.parquet&quot;</span><span class="p">),</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>            <span class="n">db_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;chroma&#39;</span><span class="p">,</span> <span class="s1">&#39;faiss&#39;</span><span class="p">,</span> <span class="s1">&#39;milvus&#39;</span><span class="p">,</span> <span class="s1">&#39;pgvector&#39;</span><span class="p">,</span> <span class="s1">&#39;pinecone&#39;</span><span class="p">,</span> <span class="s1">&#39;qdrant&#39;</span><span class="p">,</span> <span class="s1">&#39;weaviate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;milvus&quot;</span><span class="p">,</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>            <span class="n">embedding_model</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;BAAI/bge-small-en-v1.5&quot;</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>        <span class="p">):</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="n">top_k</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_model</span> <span class="o">=</span> <span class="n">HuggingFaceEmbeddings</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">embedding_model</span><span class="p">)</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temp_data_path</span> <span class="o">=</span> <span class="n">temp_data_path</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db_type</span> <span class="o">=</span> <span class="n">db_type</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>            <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>            <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">200</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>        <span class="p">)</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">doc_processor</span> <span class="o">=</span> <span class="n">DocumentProcessor</span><span class="p">(</span><span class="n">splitter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">text_splitter</span><span class="p">)</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_download_legal_case</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;joelniklaus/legal_case_document_summarization&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>        <span class="n">dataset</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_data_path</span><span class="p">)</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_legal_cases_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_download_legal_case</span><span class="p">()</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>        <span class="n">legal_case</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_data_path</span><span class="p">)</span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span> <span class="ow">in</span> <span class="n">legal_case</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>            <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a>                <span class="n">page_content</span><span class="o">=</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;judgement&#39;</span><span class="p">],</span> 
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>                    <span class="s2">&quot;judgement_case&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> 
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a>                    <span class="s2">&quot;dataset_name&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;dataset_name&quot;</span><span class="p">],</span>
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a>                    <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span>
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a>                <span class="p">})</span>
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
</span><span id="__span-10-47"><a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">docs</span>
</span><span id="__span-10-48"><a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a>
</span><span id="__span-10-49"><a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_document_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-10-50"><a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span> <span class="o">=</span> <span class="n">VectorDatabaseFactory</span><span class="p">(</span>
</span><span id="__span-10-51"><a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a>            <span class="n">db_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_type</span><span class="p">,</span>
</span><span id="__span-10-52"><a id="__codelineno-10-52" name="__codelineno-10-52" href="#__codelineno-10-52"></a>            <span class="n">embedding_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_model</span><span class="p">,</span>
</span><span id="__span-10-53"><a id="__codelineno-10-53" name="__codelineno-10-53" href="#__codelineno-10-53"></a>            <span class="n">doc_processor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">doc_processor</span>
</span><span id="__span-10-54"><a id="__codelineno-10-54" name="__codelineno-10-54" href="#__codelineno-10-54"></a>        <span class="p">)</span>
</span><span id="__span-10-55"><a id="__codelineno-10-55" name="__codelineno-10-55" href="#__codelineno-10-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_create_legal_cases_data</span><span class="p">()</span>        
</span><span id="__span-10-56"><a id="__codelineno-10-56" name="__codelineno-10-56" href="#__codelineno-10-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">store_documents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="p">)</span>
</span><span id="__span-10-57"><a id="__codelineno-10-57" name="__codelineno-10-57" href="#__codelineno-10-57"></a>
</span><span id="__span-10-58"><a id="__codelineno-10-58" name="__codelineno-10-58" href="#__codelineno-10-58"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exact_match_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
</span><span id="__span-10-59"><a id="__codelineno-10-59" name="__codelineno-10-59" href="#__codelineno-10-59"></a>        <span class="c1"># Convert strings to sets of words (case-insensitive, removing punctuation)</span>
</span><span id="__span-10-60"><a id="__codelineno-10-60" name="__codelineno-10-60" href="#__codelineno-10-60"></a>        <span class="n">query_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</span><span id="__span-10-61"><a id="__codelineno-10-61" name="__codelineno-10-61" href="#__codelineno-10-61"></a>        <span class="n">doc_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</span><span id="__span-10-62"><a id="__codelineno-10-62" name="__codelineno-10-62" href="#__codelineno-10-62"></a>
</span><span id="__span-10-63"><a id="__codelineno-10-63" name="__codelineno-10-63" href="#__codelineno-10-63"></a>        <span class="c1"># Calculate intersection of words</span>
</span><span id="__span-10-64"><a id="__codelineno-10-64" name="__codelineno-10-64" href="#__codelineno-10-64"></a>        <span class="n">common_words</span> <span class="o">=</span> <span class="n">query_words</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">doc_words</span><span class="p">)</span>
</span><span id="__span-10-65"><a id="__codelineno-10-65" name="__codelineno-10-65" href="#__codelineno-10-65"></a>
</span><span id="__span-10-66"><a id="__codelineno-10-66" name="__codelineno-10-66" href="#__codelineno-10-66"></a>        <span class="c1"># Avoid division by zero</span>
</span><span id="__span-10-67"><a id="__codelineno-10-67" name="__codelineno-10-67" href="#__codelineno-10-67"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc_words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-10-68"><a id="__codelineno-10-68" name="__codelineno-10-68" href="#__codelineno-10-68"></a>            <span class="k">return</span> <span class="mf">0.0</span>
</span><span id="__span-10-69"><a id="__codelineno-10-69" name="__codelineno-10-69" href="#__codelineno-10-69"></a>
</span><span id="__span-10-70"><a id="__codelineno-10-70" name="__codelineno-10-70" href="#__codelineno-10-70"></a>        <span class="c1"># Calculate score: 0.5 * (|V_q ∩ V_d|/|V_q| + |V_q ∩ V_d|/|V_d|)</span>
</span><span id="__span-10-71"><a id="__codelineno-10-71" name="__codelineno-10-71" href="#__codelineno-10-71"></a>        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">common_words</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_words</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_words</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc_words</span><span class="p">))</span>
</span><span id="__span-10-72"><a id="__codelineno-10-72" name="__codelineno-10-72" href="#__codelineno-10-72"></a>
</span><span id="__span-10-73"><a id="__codelineno-10-73" name="__codelineno-10-73" href="#__codelineno-10-73"></a>        <span class="k">return</span> <span class="n">score</span>
</span><span id="__span-10-74"><a id="__codelineno-10-74" name="__codelineno-10-74" href="#__codelineno-10-74"></a>
</span><span id="__span-10-75"><a id="__codelineno-10-75" name="__codelineno-10-75" href="#__codelineno-10-75"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exact_match_search_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">docs</span><span class="p">):</span>
</span><span id="__span-10-76"><a id="__codelineno-10-76" name="__codelineno-10-76" href="#__codelineno-10-76"></a>
</span><span id="__span-10-77"><a id="__codelineno-10-77" name="__codelineno-10-77" href="#__codelineno-10-77"></a>        <span class="c1"># Calculate scores for all documents</span>
</span><span id="__span-10-78"><a id="__codelineno-10-78" name="__codelineno-10-78" href="#__codelineno-10-78"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="p">[(</span><span class="n">id_doc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_match_score</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">page_content</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">id_doc</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">docs</span><span class="p">)]</span>
</span><span id="__span-10-79"><a id="__codelineno-10-79" name="__codelineno-10-79" href="#__codelineno-10-79"></a>
</span><span id="__span-10-80"><a id="__codelineno-10-80" name="__codelineno-10-80" href="#__codelineno-10-80"></a>        <span class="k">return</span> <span class="n">scores</span>
</span><span id="__span-10-81"><a id="__codelineno-10-81" name="__codelineno-10-81" href="#__codelineno-10-81"></a>
</span><span id="__span-10-82"><a id="__codelineno-10-82" name="__codelineno-10-82" href="#__codelineno-10-82"></a>
</span><span id="__span-10-83"><a id="__codelineno-10-83" name="__codelineno-10-83" href="#__codelineno-10-83"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">semantic_search_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="__span-10-84"><a id="__codelineno-10-84" name="__codelineno-10-84" href="#__codelineno-10-84"></a>        <span class="n">actual_top_k</span> <span class="o">=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_k</span>
</span><span id="__span-10-85"><a id="__codelineno-10-85" name="__codelineno-10-85" href="#__codelineno-10-85"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">vector_store</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-10-86"><a id="__codelineno-10-86" name="__codelineno-10-86" href="#__codelineno-10-86"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Vector store not initialized. Store documents first.&quot;</span><span class="p">)</span>
</span><span id="__span-10-87"><a id="__codelineno-10-87" name="__codelineno-10-87" href="#__codelineno-10-87"></a>
</span><span id="__span-10-88"><a id="__codelineno-10-88" name="__codelineno-10-88" href="#__codelineno-10-88"></a>        <span class="c1"># Generate embedding for query</span>
</span><span id="__span-10-89"><a id="__codelineno-10-89" name="__codelineno-10-89" href="#__codelineno-10-89"></a>        <span class="n">query_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">embedding_model</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="__span-10-90"><a id="__codelineno-10-90" name="__codelineno-10-90" href="#__codelineno-10-90"></a>
</span><span id="__span-10-91"><a id="__codelineno-10-91" name="__codelineno-10-91" href="#__codelineno-10-91"></a>        <span class="c1"># Perform similarity search</span>
</span><span id="__span-10-92"><a id="__codelineno-10-92" name="__codelineno-10-92" href="#__codelineno-10-92"></a>        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span><span id="__span-10-93"><a id="__codelineno-10-93" name="__codelineno-10-93" href="#__codelineno-10-93"></a>            <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
</span><span id="__span-10-94"><a id="__codelineno-10-94" name="__codelineno-10-94" href="#__codelineno-10-94"></a>            <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">query_vector</span><span class="p">],</span>
</span><span id="__span-10-95"><a id="__codelineno-10-95" name="__codelineno-10-95" href="#__codelineno-10-95"></a>            <span class="n">limit</span><span class="o">=</span><span class="n">actual_top_k</span><span class="p">,</span>
</span><span id="__span-10-96"><a id="__codelineno-10-96" name="__codelineno-10-96" href="#__codelineno-10-96"></a>            <span class="n">output_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
</span><span id="__span-10-97"><a id="__codelineno-10-97" name="__codelineno-10-97" href="#__codelineno-10-97"></a>            <span class="n">search_params</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-10-98"><a id="__codelineno-10-98" name="__codelineno-10-98" href="#__codelineno-10-98"></a>                <span class="s2">&quot;metric_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">metric_type</span>
</span><span id="__span-10-99"><a id="__codelineno-10-99" name="__codelineno-10-99" href="#__codelineno-10-99"></a>            <span class="p">},</span>  <span class="c1"># Use consistent metric type</span>
</span><span id="__span-10-100"><a id="__codelineno-10-100" name="__codelineno-10-100" href="#__codelineno-10-100"></a>        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-10-101"><a id="__codelineno-10-101" name="__codelineno-10-101" href="#__codelineno-10-101"></a>        <span class="n">returned_docs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</span><span id="__span-10-102"><a id="__codelineno-10-102" name="__codelineno-10-102" href="#__codelineno-10-102"></a>        <span class="n">returned_docs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">doc</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">returned_docs</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-10-103"><a id="__codelineno-10-103" name="__codelineno-10-103" href="#__codelineno-10-103"></a>        <span class="k">return</span> <span class="n">returned_docs</span>
</span><span id="__span-10-104"><a id="__codelineno-10-104" name="__codelineno-10-104" href="#__codelineno-10-104"></a>
</span><span id="__span-10-105"><a id="__codelineno-10-105" name="__codelineno-10-105" href="#__codelineno-10-105"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">query_fusion_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w_semantic</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
</span><span id="__span-10-106"><a id="__codelineno-10-106" name="__codelineno-10-106" href="#__codelineno-10-106"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query a list of documents based on exact matching and semantic scores. Return a list of similar documents.</span>
</span><span id="__span-10-107"><a id="__codelineno-10-107" name="__codelineno-10-107" href="#__codelineno-10-107"></a><span class="sd">        Args:</span>
</span><span id="__span-10-108"><a id="__codelineno-10-108" name="__codelineno-10-108" href="#__codelineno-10-108"></a><span class="sd">            query (str): The query to search for.</span>
</span><span id="__span-10-109"><a id="__codelineno-10-109" name="__codelineno-10-109" href="#__codelineno-10-109"></a><span class="sd">            top_k (int): The number of documents to return. Defaults to self.top_k.</span>
</span><span id="__span-10-110"><a id="__codelineno-10-110" name="__codelineno-10-110" href="#__codelineno-10-110"></a><span class="sd">            threshold (float): The minimum fusion score to return. Defaults to None.</span>
</span><span id="__span-10-111"><a id="__codelineno-10-111" name="__codelineno-10-111" href="#__codelineno-10-111"></a><span class="sd">            w_semantic (float): The weight of the semantic score. Defaults to 0.5.</span>
</span><span id="__span-10-112"><a id="__codelineno-10-112" name="__codelineno-10-112" href="#__codelineno-10-112"></a><span class="sd">        Returns:</span>
</span><span id="__span-10-113"><a id="__codelineno-10-113" name="__codelineno-10-113" href="#__codelineno-10-113"></a><span class="sd">            list: A list of similar documents.</span>
</span><span id="__span-10-114"><a id="__codelineno-10-114" name="__codelineno-10-114" href="#__codelineno-10-114"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-10-115"><a id="__codelineno-10-115" name="__codelineno-10-115" href="#__codelineno-10-115"></a>        <span class="n">exact_match_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_match_search_query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">docs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="p">)</span>
</span><span id="__span-10-116"><a id="__codelineno-10-116" name="__codelineno-10-116" href="#__codelineno-10-116"></a>        <span class="n">semantic_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semantic_search_query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="p">))</span>
</span><span id="__span-10-117"><a id="__codelineno-10-117" name="__codelineno-10-117" href="#__codelineno-10-117"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-10-118"><a id="__codelineno-10-118" name="__codelineno-10-118" href="#__codelineno-10-118"></a>            <span class="p">(</span>
</span><span id="__span-10-119"><a id="__codelineno-10-119" name="__codelineno-10-119" href="#__codelineno-10-119"></a>                <span class="n">id_exac</span><span class="p">,</span> 
</span><span id="__span-10-120"><a id="__codelineno-10-120" name="__codelineno-10-120" href="#__codelineno-10-120"></a>                <span class="p">{</span> 
</span><span id="__span-10-121"><a id="__codelineno-10-121" name="__codelineno-10-121" href="#__codelineno-10-121"></a>                    <span class="s2">&quot;semantic_score&quot;</span><span class="p">:</span> <span class="n">seman_score</span><span class="p">,</span>
</span><span id="__span-10-122"><a id="__codelineno-10-122" name="__codelineno-10-122" href="#__codelineno-10-122"></a>                    <span class="s2">&quot;exac_score&quot;</span><span class="p">:</span> <span class="n">exac_score</span><span class="p">,</span>
</span><span id="__span-10-123"><a id="__codelineno-10-123" name="__codelineno-10-123" href="#__codelineno-10-123"></a>                    <span class="s2">&quot;fusion_score&quot;</span><span class="p">:(</span><span class="mi">1</span><span class="o">-</span><span class="n">w_semantic</span><span class="p">)</span><span class="o">*</span><span class="n">exac_score</span> <span class="o">+</span> <span class="n">w_semantic</span><span class="o">*</span><span class="n">seman_score</span> 
</span><span id="__span-10-124"><a id="__codelineno-10-124" name="__codelineno-10-124" href="#__codelineno-10-124"></a>                <span class="p">}</span>
</span><span id="__span-10-125"><a id="__codelineno-10-125" name="__codelineno-10-125" href="#__codelineno-10-125"></a>            <span class="p">)</span>
</span><span id="__span-10-126"><a id="__codelineno-10-126" name="__codelineno-10-126" href="#__codelineno-10-126"></a>            <span class="k">for</span> <span class="p">((</span><span class="n">id_exac</span><span class="p">,</span> <span class="n">exac_score</span><span class="p">),</span> <span class="p">(</span><span class="n">id_seman</span><span class="p">,</span> <span class="n">seman_score</span><span class="p">))</span> 
</span><span id="__span-10-127"><a id="__codelineno-10-127" name="__codelineno-10-127" href="#__codelineno-10-127"></a>                <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">exact_match_scores</span><span class="p">,</span> <span class="n">semantic_scores</span><span class="p">))</span>
</span><span id="__span-10-128"><a id="__codelineno-10-128" name="__codelineno-10-128" href="#__codelineno-10-128"></a>        <span class="p">]</span>
</span><span id="__span-10-129"><a id="__codelineno-10-129" name="__codelineno-10-129" href="#__codelineno-10-129"></a>        <span class="n">sorted_scores</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;fusion_score&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="nb">min</span><span class="p">(</span><span class="n">top_k</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="p">))]</span>
</span><span id="__span-10-130"><a id="__codelineno-10-130" name="__codelineno-10-130" href="#__codelineno-10-130"></a>        <span class="n">sorted_docs</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">score</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sorted_scores</span><span class="p">]</span>
</span><span id="__span-10-131"><a id="__codelineno-10-131" name="__codelineno-10-131" href="#__codelineno-10-131"></a>        <span class="k">if</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="__span-10-132"><a id="__codelineno-10-132" name="__codelineno-10-132" href="#__codelineno-10-132"></a>            <span class="n">filter_docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span> <span class="k">for</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sorted_docs</span> <span class="k">if</span> <span class="n">score</span><span class="p">[</span><span class="s1">&#39;fusion_score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span>
</span><span id="__span-10-133"><a id="__codelineno-10-133" name="__codelineno-10-133" href="#__codelineno-10-133"></a>            <span class="k">return</span> <span class="n">filter_docs</span>
</span><span id="__span-10-134"><a id="__codelineno-10-134" name="__codelineno-10-134" href="#__codelineno-10-134"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-10-135"><a id="__codelineno-10-135" name="__codelineno-10-135" href="#__codelineno-10-135"></a>            <span class="k">return</span> <span class="n">sorted_docs</span>
</span></code></pre></div>
<p>Test <code>query_fusion_score</code> method, which combines the exact matching score and semantic score, to retrieve a list of legal cases related to <code>Sales Tax</code>.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">search_legal_engine</span> <span class="o">=</span> <span class="n">SearchLegalEngine</span><span class="p">(</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="n">temp_data_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data/test.parquet&quot;</span><span class="p">),</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="n">db_type</span><span class="o">=</span><span class="s2">&quot;milvus&quot;</span><span class="p">,</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="n">embedding_model</span><span class="o">=</span><span class="s2">&quot;BAAI/bge-small-en-v1.5&quot;</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="p">)</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="n">search_legal_engine</span><span class="o">.</span><span class="n">_initialize_document_processor</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Repo card metadata block was not found. Setting CardData to empty.
Creating parquet from Arrow format: 100%|██████████| 1/1 [00:00&lt;00:00, 18.59ba/s]
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;claimed exemption from Sales Tax&quot;</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">search_legal_engine</span><span class="o">.</span><span class="n">query_fusion_score</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">w_semantic</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>[
    (Document(metadata={&#39;judgement_case&#39;: 162, &#39;dataset_name&#39;: &#39;UK-Abs&#39;, &#39;summary&#39;: &#39;This appeal and cross appeal arise out of claims made by...&#39;}),
    {&#39;semantic_score&#39;: 0.7400172352790833,
    &#39;exac_score&#39;: 0.5009107468123861,
    &#39;fusion_score&#39;: 0.668285288739074}),
    (Document(metadata={&#39;judgement_case&#39;: 165, &#39;dataset_name&#39;: &#39;UK-Abs&#39;, &#39;summary&#39;: &#39;Littlewoods overpaid VAT to HMRC between 1973 and 2004...&#39;}),
    {&#39;semantic_score&#39;: 0.7034813165664673,
    &#39;exac_score&#39;: 0.4009132420091324,
    &#39;fusion_score&#39;: 0.6127108941992668}),
    (Document(metadata={&#39;judgement_case&#39;: 2, &#39;dataset_name&#39;: &#39;IN-Abs&#39;, &#39;summary&#39;: &#39;The respondents firm claimed exemption from Sales Tax under...&#39;}),
    {&#39;semantic_score&#39;: 0.6283447742462158,
    &#39;exac_score&#39;: 0.5035360678925035,
    &#39;fusion_score&#39;: 0.5909021623401021}),
    (Document(metadata={&#39;judgement_case&#39;: 87, &#39;dataset_name&#39;: &#39;IN-Abs&#39;, &#39;summary&#39;: &#39;Each of the appellants/petitioners is a registered dealer in...&#39;}),
    {&#39;semantic_score&#39;: 0.6285038590431213,
    &#39;exac_score&#39;: 0.5016891891891891,
    &#39;fusion_score&#39;: 0.5904594580869417}),
    (Document(metadata={&#39;judgement_case&#39;: 154, &#39;dataset_name&#39;: &#39;UK-Abs&#39;, &#39;summary&#39;: &#39;The benefit cap was introduced in the Welfare Reform Act 2012...&#39;}),
    {&#39;semantic_score&#39;: 0.613065779209137,
    &#39;exac_score&#39;: 0.5004644250417982,
    &#39;fusion_score&#39;: 0.5792853729589353})
]
</code></pre></div>
<p>Now, let's save code into a module file <code>vinagent/tools/legal_assistant/search_legal_cases.py</code>, which will be loaded as a search tool in the next case.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="o">%%</span><span class="n">writefile</span> <span class="n">vinagent</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">legal_assistant</span><span class="o">/</span><span class="n">search_legal_cases</span><span class="o">.</span><span class="n">py</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dataset</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.documents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Document</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain.text_splitter</span><span class="w"> </span><span class="kn">import</span> <span class="n">RecursiveCharacterTextSplitter</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_huggingface</span><span class="w"> </span><span class="kn">import</span> <span class="n">HuggingFaceEmbeddings</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aucodb.vectordb.factory</span><span class="w"> </span><span class="kn">import</span> <span class="n">VectorDatabaseFactory</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="kn">from</span><span class="w"> </span><span class="nn">aucodb.vectordb.processor</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocumentProcessor</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vinagent.register</span><span class="w"> </span><span class="kn">import</span> <span class="n">primary_function</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">SearchLegalEngine</span><span class="p">:</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>            <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>            <span class="n">temp_data_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data/test.parquet&quot;</span><span class="p">),</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>            <span class="n">db_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;chroma&#39;</span><span class="p">,</span> <span class="s1">&#39;faiss&#39;</span><span class="p">,</span> <span class="s1">&#39;milvus&#39;</span><span class="p">,</span> <span class="s1">&#39;pgvector&#39;</span><span class="p">,</span> <span class="s1">&#39;pinecone&#39;</span><span class="p">,</span> <span class="s1">&#39;qdrant&#39;</span><span class="p">,</span> <span class="s1">&#39;weaviate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;milvus&quot;</span><span class="p">,</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>            <span class="n">embedding_model</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;BAAI/bge-small-en-v1.5&quot;</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>        <span class="p">):</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">top_k</span> <span class="o">=</span> <span class="n">top_k</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_model</span> <span class="o">=</span> <span class="n">HuggingFaceEmbeddings</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">embedding_model</span><span class="p">)</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temp_data_path</span> <span class="o">=</span> <span class="n">temp_data_path</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">db_type</span> <span class="o">=</span> <span class="n">db_type</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">text_splitter</span> <span class="o">=</span> <span class="n">RecursiveCharacterTextSplitter</span><span class="p">(</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>            <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>            <span class="n">chunk_overlap</span><span class="o">=</span><span class="mi">200</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>        <span class="p">)</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">doc_processor</span> <span class="o">=</span> <span class="n">DocumentProcessor</span><span class="p">(</span><span class="n">splitter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">text_splitter</span><span class="p">)</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_download_legal_case</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;joelniklaus/legal_case_document_summarization&quot;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>        <span class="n">dataset</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_data_path</span><span class="p">)</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_legal_cases_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_download_legal_case</span><span class="p">()</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>        <span class="n">legal_case</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_data_path</span><span class="p">)</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span> <span class="ow">in</span> <span class="n">legal_case</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a>            <span class="n">doc</span> <span class="o">=</span> <span class="n">Document</span><span class="p">(</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>                <span class="n">page_content</span><span class="o">=</span><span class="n">doc</span><span class="p">[</span><span class="s1">&#39;judgement&#39;</span><span class="p">],</span> 
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a>                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a>                    <span class="s2">&quot;judgement_case&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> 
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a>                    <span class="s2">&quot;dataset_name&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;dataset_name&quot;</span><span class="p">],</span>
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a>                    <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span>
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49" href="#__codelineno-13-49"></a>                <span class="p">})</span>
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50" href="#__codelineno-13-50"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51" href="#__codelineno-13-51"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">docs</span>
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52" href="#__codelineno-13-52"></a>
</span><span id="__span-13-53"><a id="__codelineno-13-53" name="__codelineno-13-53" href="#__codelineno-13-53"></a>
</span><span id="__span-13-54"><a id="__codelineno-13-54" name="__codelineno-13-54" href="#__codelineno-13-54"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_initialize_document_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="__span-13-55"><a id="__codelineno-13-55" name="__codelineno-13-55" href="#__codelineno-13-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span> <span class="o">=</span> <span class="n">VectorDatabaseFactory</span><span class="p">(</span>
</span><span id="__span-13-56"><a id="__codelineno-13-56" name="__codelineno-13-56" href="#__codelineno-13-56"></a>            <span class="n">db_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">db_type</span><span class="p">,</span>
</span><span id="__span-13-57"><a id="__codelineno-13-57" name="__codelineno-13-57" href="#__codelineno-13-57"></a>            <span class="n">embedding_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">embedding_model</span><span class="p">,</span>
</span><span id="__span-13-58"><a id="__codelineno-13-58" name="__codelineno-13-58" href="#__codelineno-13-58"></a>            <span class="n">doc_processor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">doc_processor</span>
</span><span id="__span-13-59"><a id="__codelineno-13-59" name="__codelineno-13-59" href="#__codelineno-13-59"></a>        <span class="p">)</span>
</span><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60" href="#__codelineno-13-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_create_legal_cases_data</span><span class="p">()</span>        
</span><span id="__span-13-61"><a id="__codelineno-13-61" name="__codelineno-13-61" href="#__codelineno-13-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">store_documents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="p">)</span>
</span><span id="__span-13-62"><a id="__codelineno-13-62" name="__codelineno-13-62" href="#__codelineno-13-62"></a>
</span><span id="__span-13-63"><a id="__codelineno-13-63" name="__codelineno-13-63" href="#__codelineno-13-63"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exact_match_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
</span><span id="__span-13-64"><a id="__codelineno-13-64" name="__codelineno-13-64" href="#__codelineno-13-64"></a>        <span class="c1"># Convert strings to sets of words (case-insensitive, removing punctuation)</span>
</span><span id="__span-13-65"><a id="__codelineno-13-65" name="__codelineno-13-65" href="#__codelineno-13-65"></a>        <span class="n">query_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</span><span id="__span-13-66"><a id="__codelineno-13-66" name="__codelineno-13-66" href="#__codelineno-13-66"></a>        <span class="n">doc_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
</span><span id="__span-13-67"><a id="__codelineno-13-67" name="__codelineno-13-67" href="#__codelineno-13-67"></a>
</span><span id="__span-13-68"><a id="__codelineno-13-68" name="__codelineno-13-68" href="#__codelineno-13-68"></a>        <span class="c1"># Calculate intersection of words</span>
</span><span id="__span-13-69"><a id="__codelineno-13-69" name="__codelineno-13-69" href="#__codelineno-13-69"></a>        <span class="n">common_words</span> <span class="o">=</span> <span class="n">query_words</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">doc_words</span><span class="p">)</span>
</span><span id="__span-13-70"><a id="__codelineno-13-70" name="__codelineno-13-70" href="#__codelineno-13-70"></a>
</span><span id="__span-13-71"><a id="__codelineno-13-71" name="__codelineno-13-71" href="#__codelineno-13-71"></a>        <span class="c1"># Avoid division by zero</span>
</span><span id="__span-13-72"><a id="__codelineno-13-72" name="__codelineno-13-72" href="#__codelineno-13-72"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc_words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="__span-13-73"><a id="__codelineno-13-73" name="__codelineno-13-73" href="#__codelineno-13-73"></a>            <span class="k">return</span> <span class="mf">0.0</span>
</span><span id="__span-13-74"><a id="__codelineno-13-74" name="__codelineno-13-74" href="#__codelineno-13-74"></a>
</span><span id="__span-13-75"><a id="__codelineno-13-75" name="__codelineno-13-75" href="#__codelineno-13-75"></a>        <span class="c1"># Calculate score: 0.5 * (|V_q ∩ V_d|/|V_q| + |V_q ∩ V_d|/|V_d|)</span>
</span><span id="__span-13-76"><a id="__codelineno-13-76" name="__codelineno-13-76" href="#__codelineno-13-76"></a>        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">common_words</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_words</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_words</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc_words</span><span class="p">))</span>
</span><span id="__span-13-77"><a id="__codelineno-13-77" name="__codelineno-13-77" href="#__codelineno-13-77"></a>
</span><span id="__span-13-78"><a id="__codelineno-13-78" name="__codelineno-13-78" href="#__codelineno-13-78"></a>        <span class="k">return</span> <span class="n">score</span>
</span><span id="__span-13-79"><a id="__codelineno-13-79" name="__codelineno-13-79" href="#__codelineno-13-79"></a>
</span><span id="__span-13-80"><a id="__codelineno-13-80" name="__codelineno-13-80" href="#__codelineno-13-80"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exact_match_search_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">docs</span><span class="p">):</span>
</span><span id="__span-13-81"><a id="__codelineno-13-81" name="__codelineno-13-81" href="#__codelineno-13-81"></a>        <span class="c1"># Calculate scores for all documents</span>
</span><span id="__span-13-82"><a id="__codelineno-13-82" name="__codelineno-13-82" href="#__codelineno-13-82"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="p">[(</span><span class="n">id_doc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_match_score</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">page_content</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">id_doc</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">docs</span><span class="p">)]</span>
</span><span id="__span-13-83"><a id="__codelineno-13-83" name="__codelineno-13-83" href="#__codelineno-13-83"></a>        <span class="k">return</span> <span class="n">scores</span>
</span><span id="__span-13-84"><a id="__codelineno-13-84" name="__codelineno-13-84" href="#__codelineno-13-84"></a>
</span><span id="__span-13-85"><a id="__codelineno-13-85" name="__codelineno-13-85" href="#__codelineno-13-85"></a>
</span><span id="__span-13-86"><a id="__codelineno-13-86" name="__codelineno-13-86" href="#__codelineno-13-86"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">semantic_search_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
</span><span id="__span-13-87"><a id="__codelineno-13-87" name="__codelineno-13-87" href="#__codelineno-13-87"></a>        <span class="n">actual_top_k</span> <span class="o">=</span> <span class="n">top_k</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_k</span>
</span><span id="__span-13-88"><a id="__codelineno-13-88" name="__codelineno-13-88" href="#__codelineno-13-88"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">vector_store</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="__span-13-89"><a id="__codelineno-13-89" name="__codelineno-13-89" href="#__codelineno-13-89"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Vector store not initialized. Store documents first.&quot;</span><span class="p">)</span>
</span><span id="__span-13-90"><a id="__codelineno-13-90" name="__codelineno-13-90" href="#__codelineno-13-90"></a>
</span><span id="__span-13-91"><a id="__codelineno-13-91" name="__codelineno-13-91" href="#__codelineno-13-91"></a>        <span class="c1"># Generate embedding for query</span>
</span><span id="__span-13-92"><a id="__codelineno-13-92" name="__codelineno-13-92" href="#__codelineno-13-92"></a>        <span class="n">query_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">embedding_model</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span><span id="__span-13-93"><a id="__codelineno-13-93" name="__codelineno-13-93" href="#__codelineno-13-93"></a>
</span><span id="__span-13-94"><a id="__codelineno-13-94" name="__codelineno-13-94" href="#__codelineno-13-94"></a>        <span class="c1"># Perform similarity search</span>
</span><span id="__span-13-95"><a id="__codelineno-13-95" name="__codelineno-13-95" href="#__codelineno-13-95"></a>        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span><span id="__span-13-96"><a id="__codelineno-13-96" name="__codelineno-13-96" href="#__codelineno-13-96"></a>            <span class="n">collection_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">collection_name</span><span class="p">,</span>
</span><span id="__span-13-97"><a id="__codelineno-13-97" name="__codelineno-13-97" href="#__codelineno-13-97"></a>            <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">query_vector</span><span class="p">],</span>
</span><span id="__span-13-98"><a id="__codelineno-13-98" name="__codelineno-13-98" href="#__codelineno-13-98"></a>            <span class="n">limit</span><span class="o">=</span><span class="n">actual_top_k</span><span class="p">,</span>
</span><span id="__span-13-99"><a id="__codelineno-13-99" name="__codelineno-13-99" href="#__codelineno-13-99"></a>            <span class="n">output_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
</span><span id="__span-13-100"><a id="__codelineno-13-100" name="__codelineno-13-100" href="#__codelineno-13-100"></a>            <span class="n">search_params</span><span class="o">=</span><span class="p">{</span>
</span><span id="__span-13-101"><a id="__codelineno-13-101" name="__codelineno-13-101" href="#__codelineno-13-101"></a>                <span class="s2">&quot;metric_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vectordb_factory</span><span class="o">.</span><span class="n">vectordb</span><span class="o">.</span><span class="n">metric_type</span>
</span><span id="__span-13-102"><a id="__codelineno-13-102" name="__codelineno-13-102" href="#__codelineno-13-102"></a>            <span class="p">},</span>  <span class="c1"># Use consistent metric type</span>
</span><span id="__span-13-103"><a id="__codelineno-13-103" name="__codelineno-13-103" href="#__codelineno-13-103"></a>        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-13-104"><a id="__codelineno-13-104" name="__codelineno-13-104" href="#__codelineno-13-104"></a>        <span class="n">returned_docs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</span><span id="__span-13-105"><a id="__codelineno-13-105" name="__codelineno-13-105" href="#__codelineno-13-105"></a>        <span class="n">returned_docs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">doc</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">returned_docs</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-13-106"><a id="__codelineno-13-106" name="__codelineno-13-106" href="#__codelineno-13-106"></a>        <span class="k">return</span> <span class="n">returned_docs</span>
</span><span id="__span-13-107"><a id="__codelineno-13-107" name="__codelineno-13-107" href="#__codelineno-13-107"></a>
</span><span id="__span-13-108"><a id="__codelineno-13-108" name="__codelineno-13-108" href="#__codelineno-13-108"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">query_fusion_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w_semantic</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
</span><span id="__span-13-109"><a id="__codelineno-13-109" name="__codelineno-13-109" href="#__codelineno-13-109"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Query a list of documents based on exact matching and semantic scores. Return a list of similar documents.</span>
</span><span id="__span-13-110"><a id="__codelineno-13-110" name="__codelineno-13-110" href="#__codelineno-13-110"></a><span class="sd">        Args:</span>
</span><span id="__span-13-111"><a id="__codelineno-13-111" name="__codelineno-13-111" href="#__codelineno-13-111"></a><span class="sd">            query (str): The query to search for.</span>
</span><span id="__span-13-112"><a id="__codelineno-13-112" name="__codelineno-13-112" href="#__codelineno-13-112"></a><span class="sd">            top_k (int): The number of documents to return. Defaults to self.top_k.</span>
</span><span id="__span-13-113"><a id="__codelineno-13-113" name="__codelineno-13-113" href="#__codelineno-13-113"></a><span class="sd">            threshold (float): The minimum fusion score to return. Defaults to None.</span>
</span><span id="__span-13-114"><a id="__codelineno-13-114" name="__codelineno-13-114" href="#__codelineno-13-114"></a><span class="sd">            w_semantic (float): The weight of the semantic score. Defaults to 0.5.</span>
</span><span id="__span-13-115"><a id="__codelineno-13-115" name="__codelineno-13-115" href="#__codelineno-13-115"></a><span class="sd">        Returns:</span>
</span><span id="__span-13-116"><a id="__codelineno-13-116" name="__codelineno-13-116" href="#__codelineno-13-116"></a><span class="sd">            list: A list of similar documents.</span>
</span><span id="__span-13-117"><a id="__codelineno-13-117" name="__codelineno-13-117" href="#__codelineno-13-117"></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="__span-13-118"><a id="__codelineno-13-118" name="__codelineno-13-118" href="#__codelineno-13-118"></a>        <span class="n">exact_match_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exact_match_search_query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">docs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="p">)</span>
</span><span id="__span-13-119"><a id="__codelineno-13-119" name="__codelineno-13-119" href="#__codelineno-13-119"></a>        <span class="n">semantic_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semantic_search_query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="p">))</span>
</span><span id="__span-13-120"><a id="__codelineno-13-120" name="__codelineno-13-120" href="#__codelineno-13-120"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-13-121"><a id="__codelineno-13-121" name="__codelineno-13-121" href="#__codelineno-13-121"></a>            <span class="p">(</span>
</span><span id="__span-13-122"><a id="__codelineno-13-122" name="__codelineno-13-122" href="#__codelineno-13-122"></a>                <span class="n">id_exac</span><span class="p">,</span> 
</span><span id="__span-13-123"><a id="__codelineno-13-123" name="__codelineno-13-123" href="#__codelineno-13-123"></a>                <span class="p">{</span> 
</span><span id="__span-13-124"><a id="__codelineno-13-124" name="__codelineno-13-124" href="#__codelineno-13-124"></a>                    <span class="s2">&quot;semantic_score&quot;</span><span class="p">:</span> <span class="n">seman_score</span><span class="p">,</span>
</span><span id="__span-13-125"><a id="__codelineno-13-125" name="__codelineno-13-125" href="#__codelineno-13-125"></a>                    <span class="s2">&quot;exac_score&quot;</span><span class="p">:</span> <span class="n">exac_score</span><span class="p">,</span>
</span><span id="__span-13-126"><a id="__codelineno-13-126" name="__codelineno-13-126" href="#__codelineno-13-126"></a>                    <span class="s2">&quot;fusion_score&quot;</span><span class="p">:(</span><span class="mi">1</span><span class="o">-</span><span class="n">w_semantic</span><span class="p">)</span><span class="o">*</span><span class="n">exac_score</span> <span class="o">+</span> <span class="n">w_semantic</span><span class="o">*</span><span class="n">seman_score</span> 
</span><span id="__span-13-127"><a id="__codelineno-13-127" name="__codelineno-13-127" href="#__codelineno-13-127"></a>                <span class="p">}</span>
</span><span id="__span-13-128"><a id="__codelineno-13-128" name="__codelineno-13-128" href="#__codelineno-13-128"></a>            <span class="p">)</span>
</span><span id="__span-13-129"><a id="__codelineno-13-129" name="__codelineno-13-129" href="#__codelineno-13-129"></a>            <span class="k">for</span> <span class="p">((</span><span class="n">id_exac</span><span class="p">,</span> <span class="n">exac_score</span><span class="p">),</span> <span class="p">(</span><span class="n">id_seman</span><span class="p">,</span> <span class="n">seman_score</span><span class="p">))</span> 
</span><span id="__span-13-130"><a id="__codelineno-13-130" name="__codelineno-13-130" href="#__codelineno-13-130"></a>                <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">exact_match_scores</span><span class="p">,</span> <span class="n">semantic_scores</span><span class="p">))</span>
</span><span id="__span-13-131"><a id="__codelineno-13-131" name="__codelineno-13-131" href="#__codelineno-13-131"></a>        <span class="p">]</span>
</span><span id="__span-13-132"><a id="__codelineno-13-132" name="__codelineno-13-132" href="#__codelineno-13-132"></a>        <span class="n">sorted_scores</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;fusion_score&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="nb">min</span><span class="p">(</span><span class="n">top_k</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="p">))]</span>
</span><span id="__span-13-133"><a id="__codelineno-13-133" name="__codelineno-13-133" href="#__codelineno-13-133"></a>        <span class="n">sorted_docs</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">score</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sorted_scores</span><span class="p">]</span>
</span><span id="__span-13-134"><a id="__codelineno-13-134" name="__codelineno-13-134" href="#__codelineno-13-134"></a>        <span class="k">if</span> <span class="n">threshold</span><span class="p">:</span>
</span><span id="__span-13-135"><a id="__codelineno-13-135" name="__codelineno-13-135" href="#__codelineno-13-135"></a>            <span class="n">filter_docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span> <span class="k">for</span> <span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sorted_docs</span> <span class="k">if</span> <span class="n">score</span><span class="p">[</span><span class="s1">&#39;fusion_score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span>
</span><span id="__span-13-136"><a id="__codelineno-13-136" name="__codelineno-13-136" href="#__codelineno-13-136"></a>            <span class="k">return</span> <span class="n">filter_docs</span>
</span><span id="__span-13-137"><a id="__codelineno-13-137" name="__codelineno-13-137" href="#__codelineno-13-137"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-13-138"><a id="__codelineno-13-138" name="__codelineno-13-138" href="#__codelineno-13-138"></a>            <span class="k">return</span> <span class="n">sorted_docs</span>
</span><span id="__span-13-139"><a id="__codelineno-13-139" name="__codelineno-13-139" href="#__codelineno-13-139"></a>
</span><span id="__span-13-140"><a id="__codelineno-13-140" name="__codelineno-13-140" href="#__codelineno-13-140"></a><span class="nd">@primary_function</span>
</span><span id="__span-13-141"><a id="__codelineno-13-141" name="__codelineno-13-141" href="#__codelineno-13-141"></a><span class="k">def</span><span class="w"> </span><span class="nf">query_similar_legal_cases</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n_legal_cases</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
</span><span id="__span-13-142"><a id="__codelineno-13-142" name="__codelineno-13-142" href="#__codelineno-13-142"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Query the similar legal cases to the given query.</span>
</span><span id="__span-13-143"><a id="__codelineno-13-143" name="__codelineno-13-143" href="#__codelineno-13-143"></a><span class="sd">    Args:</span>
</span><span id="__span-13-144"><a id="__codelineno-13-144" name="__codelineno-13-144" href="#__codelineno-13-144"></a><span class="sd">        query (str): The query string.</span>
</span><span id="__span-13-145"><a id="__codelineno-13-145" name="__codelineno-13-145" href="#__codelineno-13-145"></a><span class="sd">        n_legal_cases (int): The number of legal cases</span>
</span><span id="__span-13-146"><a id="__codelineno-13-146" name="__codelineno-13-146" href="#__codelineno-13-146"></a><span class="sd">        threshold (float): The similarity threshold. Defaults to 0.6.</span>
</span><span id="__span-13-147"><a id="__codelineno-13-147" name="__codelineno-13-147" href="#__codelineno-13-147"></a>
</span><span id="__span-13-148"><a id="__codelineno-13-148" name="__codelineno-13-148" href="#__codelineno-13-148"></a><span class="sd">    Returns:</span>
</span><span id="__span-13-149"><a id="__codelineno-13-149" name="__codelineno-13-149" href="#__codelineno-13-149"></a><span class="sd">        The similar legal cases.</span>
</span><span id="__span-13-150"><a id="__codelineno-13-150" name="__codelineno-13-150" href="#__codelineno-13-150"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-13-151"><a id="__codelineno-13-151" name="__codelineno-13-151" href="#__codelineno-13-151"></a>    <span class="n">search_legal_engine</span> <span class="o">=</span> <span class="n">SearchLegalEngine</span><span class="p">(</span>
</span><span id="__span-13-152"><a id="__codelineno-13-152" name="__codelineno-13-152" href="#__codelineno-13-152"></a>        <span class="n">top_k</span><span class="o">=</span><span class="n">n_legal_cases</span><span class="p">,</span> 
</span><span id="__span-13-153"><a id="__codelineno-13-153" name="__codelineno-13-153" href="#__codelineno-13-153"></a>        <span class="n">temp_data_path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data/test.parquet&quot;</span><span class="p">),</span>
</span><span id="__span-13-154"><a id="__codelineno-13-154" name="__codelineno-13-154" href="#__codelineno-13-154"></a>        <span class="n">db_type</span><span class="o">=</span><span class="s2">&quot;milvus&quot;</span><span class="p">,</span>
</span><span id="__span-13-155"><a id="__codelineno-13-155" name="__codelineno-13-155" href="#__codelineno-13-155"></a>        <span class="n">embedding_model</span><span class="o">=</span><span class="s2">&quot;BAAI/bge-small-en-v1.5&quot;</span>
</span><span id="__span-13-156"><a id="__codelineno-13-156" name="__codelineno-13-156" href="#__codelineno-13-156"></a>    <span class="p">)</span>
</span><span id="__span-13-157"><a id="__codelineno-13-157" name="__codelineno-13-157" href="#__codelineno-13-157"></a>    <span class="n">search_legal_engine</span><span class="o">.</span><span class="n">_create_legal_cases_data</span><span class="p">()</span>
</span><span id="__span-13-158"><a id="__codelineno-13-158" name="__codelineno-13-158" href="#__codelineno-13-158"></a>    <span class="n">search_legal_engine</span><span class="o">.</span><span class="n">_initialize_document_processor</span><span class="p">()</span>
</span><span id="__span-13-159"><a id="__codelineno-13-159" name="__codelineno-13-159" href="#__codelineno-13-159"></a>    <span class="n">docs</span> <span class="o">=</span> <span class="n">search_legal_engine</span><span class="o">.</span><span class="n">query_fusion_score</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="n">n_legal_cases</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">w_semantic</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</span><span id="__span-13-160"><a id="__codelineno-13-160" name="__codelineno-13-160" href="#__codelineno-13-160"></a>    <span class="k">return</span> <span class="n">docs</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Overwriting vinagent/tools/legal_assistant/search_legal_cases.py
</code></pre></div>
<h2 id="initialize-legal-agent">Initialize Legal Agent<a class="headerlink" href="#initialize-legal-agent" title="Permanent link">&para;</a></h2>
<p>We demonstrate how to initialize a legal assistant on vinagent, which can assist users with tasks such as:</p>
<ul>
<li>
<p>Searching for relevant legal cases.</p>
</li>
<li>
<p>Summarizing the major timeline of events in a specific legal case.</p>
</li>
<li>
<p>Analyzing arguments to identify the strengths and weaknesses of the appellants’ claims.</p>
</li>
<li>
<p>Conducting jurisdictional analysis of the Act and Regulation.</p>
</li>
<li>
<p>Analyzing ethics and potential bias in court rulings.</p>
</li>
</ul>
<p>Let's initialize the legal_agent with relevant description, skills, and tools.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vinagent.agent.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">vinagent.agent.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span><span class="p">,</span> <span class="n">find_dotenv</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="n">load_dotenv</span><span class="p">(</span><span class="n">find_dotenv</span><span class="p">(</span><span class="s1">&#39;.env&#39;</span><span class="p">))</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;o4-mini&quot;</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="p">)</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="n">legal_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Legal Assistant&quot;</span><span class="p">,</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A legal assistant who can find the similar legal cases&quot;</span><span class="p">,</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>    <span class="n">llm</span> <span class="o">=</span> <span class="n">llm</span><span class="p">,</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>    <span class="n">skills</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>        <span class="s2">&quot;search similar legal cases&quot;</span><span class="p">,</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>        <span class="s2">&quot;summary the legal cases&quot;</span><span class="p">,</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>        <span class="s2">&quot;extract the main timeline in the legal cases&quot;</span><span class="p">,</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>        <span class="s2">&quot;search information on the internet&quot;</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>    <span class="p">],</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>    <span class="n">tools</span><span class="o">=</span><span class="p">[</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>        <span class="s1">&#39;vinagent/tools/legal_assistant/search_legal_cases.py&#39;</span><span class="p">,</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>        <span class="s1">&#39;vinagent/tools/websearch_tools.py&#39;</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>    <span class="p">]</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions &quot;HTTP/1.1 200 OK&quot;
INFO:vinagent.register.tool:Registered query_similar_legal_cases:
{&#39;tool_name&#39;: &#39;query_similar_legal_cases&#39;, &#39;arguments&#39;: {&#39;n_legal_cases&#39;: 2, &#39;threshold&#39;: 0.6}, &#39;return&#39;: &#39;The similar legal cases.&#39;, &#39;docstring&#39;: &#39;Query the similar legal cases to the given query.\n    Args:\n        query (str): The query string.\n        n_legal_cases (int): The number of legal cases\n        threshold (float): The similarity threshold. Defaults to 0.6.\n    Returns:\n        The similar legal cases.&#39;, &#39;dependencies&#39;: [&#39;pandas&#39;, &#39;datasets&#39;, &#39;pathlib&#39;, &#39;langchain_core&#39;, &#39;langchain.text_splitter&#39;, &#39;langchain_huggingface&#39;, &#39;aucodb&#39;, &#39;vinagent&#39;], &#39;module_path&#39;: &#39;vinagent.tools.search_legal_cases&#39;, &#39;tool_type&#39;: &#39;module&#39;, &#39;tool_call_id&#39;: &#39;tool_331a2f3a-8bc9-454a-89b3-2ad3c8ac074e&#39;}
INFO:vinagent.register.tool:Completed registration for module vinagent.tools.search_legal_cases
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions &quot;HTTP/1.1 200 OK&quot;
INFO:vinagent.register.tool:Registered search_api:
{&#39;tool_name&#39;: &#39;search_api&#39;, &#39;arguments&#39;: &#39;query: Union[str, dict[str, str]]&#39;, &#39;return&#39;: &#39;The answer from search query&#39;, &#39;docstring&#39;: &#39;Search for an answer from a query string\nArgs:\n    query (dict[str, str]):  The input query to search\nReturns:\n    The answer from search query&#39;, &#39;dependencies&#39;: [&#39;os&#39;, &#39;dotenv&#39;, &#39;tavily&#39;, &#39;dataclasses&#39;, &#39;typing&#39;, &#39;vinagent.register&#39;], &#39;module_path&#39;: &#39;vinagent.tools.websearch_tools&#39;, &#39;tool_type&#39;: &#39;module&#39;, &#39;tool_call_id&#39;: &#39;tool_f0647aec-0361-4791-9f05-ffa05f2d9f98&#39;}
INFO:vinagent.register.tool:Completed registration for module vinagent.tools.websearch_tools
</code></pre></div>
<h2 id="find-the-relevant-legal-case">Find the relevant legal case<a class="headerlink" href="#find-the-relevant-legal-case" title="Permanent link">&para;</a></h2>
<p>Attorney usually finds the relevant legal cases to prepare before starting a lawsuit. The primary target of finding similar legal cases is to identify relevant precedents that guide the resolution of a current case, ensuring consistency and fairness in legal outcomes. By researching cases with comparable facts or legal issues, attorneys can build stronger arguments, predict judicial rulings, and uncover defenses or counterarguments. This process supports compliance with the principle of stare decisis, enhances case strategy, and provides leverage in negotiations, ultimately saving time and resources while grounding legal decisions in established judicial authority.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">message</span> <span class="o">=</span> <span class="n">legal_agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    <span class="s2">&quot;Let find one legal case claimed exemption sales tax&quot;</span><span class="p">,</span> 
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="n">is_tool_formatted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="n">max_history</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="p">)</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="n">message</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>INFO:vinagent.agent.agent:Executing tool call: {&#39;tool_name&#39;: &#39;search_api&#39;, &#39;tool_type&#39;: &#39;module&#39;, &#39;arguments&#39;: {&#39;query&#39;: &#39;legal case sales tax exemption claimed&#39;}, &#39;module_path&#39;: &#39;vinagent.tools.websearch_tools&#39;}
INFO:vinagent.register.tool:Completed executing module tool search_api({&#39;query&#39;: &#39;legal case sales tax exemption claimed&#39;})

ToolMessage(content=&quot;Completed executing module tool search_api({&#39;query&#39;: &#39;legal case sales tax exemption claimed&#39;})&quot;, tool_call_id=&#39;tool_f0647aec-0361-4791-9f05-ffa05f2d9f98&#39;, artifact=&quot;Sales tax exemptions were claimed in various legal cases, including a Mississippi case about medical devices and a Missouri case about electronic price scanners. The Supreme Court struck down a Texas statute exempting religious publications from sales tax. Nonprofits&#39; tax exemptions were also challenged.&quot;)
</code></pre></div>
<p>This is the main content of a similar legal case.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">message</span><span class="o">.</span><span class="n">artifact</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>&quot;Sales tax exemptions were claimed in various legal cases, including a Mississippi case about medical devices and a Missouri case about electronic price scanners. The Supreme Court struck down a Texas statute exempting religious publications from sales tax. Nonprofits&#39; tax exemptions were also challenged.&quot;
</code></pre></div>
<p>In there, only use <code>is_tool_formatted=False</code> while disabling modification tool message in the next step. We set <code>max_history=1</code> to enable only the last query in current context and remove history. That ensures the context length does not exceed the maximum length accepted by the LLM, which usually happens while legal cases have long context.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">legal_agent</span><span class="o">.</span><span class="n">in_conversation_history</span><span class="o">.</span><span class="n">get_history</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>[SystemMessage(content=&#39;A legal assistant who can find the similar legal cases\nHere is your skills:\n- search similar legal cases- summary the legal cases- extract the main entities in the legal cases- search information on the internet&#39;, additional_kwargs={}, response_metadata={}),
 HumanMessage(content=&#39;You are given a task, a list of available tools, and the memory about user to have precise information.\n- Task: Let find one legal case claimed exemption sales tax\n- Tools list: {&quot;search_api&quot;: {&quot;tool_name&quot;: &quot;search_api&quot;, &quot;arguments&quot;: &quot;query: Union[str, dict[str, str]]&quot;, &quot;return&quot;: &quot;The answer from search query&quot;, &quot;docstring&quot;: &quot;Search for an answer from a query string\\nArgs:\\n    query (dict[str, str]):  The input query to search\\nReturns:\\n    The answer from search query&quot;, &quot;dependencies&quot;: [&quot;os&quot;, &quot;dotenv&quot;, &quot;tavily&quot;, &quot;dataclasses&quot;, &quot;typing&quot;, &quot;vinagent.register&quot;], &quot;module_path&quot;: &quot;vinagent.tools.websearch_tools&quot;, &quot;tool_type&quot;: &quot;module&quot;, &quot;tool_call_id&quot;: &quot;tool_f0647aec-0361-4791-9f05-ffa05f2d9f98&quot;}, &quot;trending_news_google_tools&quot;: {&quot;tool_name&quot;: &quot;trending_news_google_tools&quot;, &quot;arguments&quot;: {&quot;top_k&quot;: 5, &quot;topic&quot;: &quot;AI&quot;, &quot;host_language&quot;: &quot;en-US&quot;, &quot;geo_location&quot;: &quot;US&quot;}, &quot;return&quot;: &quot;a list of dictionaries containing the title, link, and summary of the top trending news&quot;, &quot;docstring&quot;: &quot;Summarize the top trending news from Google News from a given topic.&quot;, &quot;dependencies&quot;: [&quot;requests&quot;, &quot;BeautifulSoup&quot;, &quot;pandas&quot;, &quot;langchain_together&quot;, &quot;googlenewsdecoder&quot;, &quot;dotenv&quot;], &quot;module_path&quot;: &quot;vinagent.tools.trending_news&quot;, &quot;tool_type&quot;: &quot;module&quot;, &quot;tool_call_id&quot;: &quot;tool_56da458b-7ac5-49da-ac2e-2b7857a69817&quot;}, &quot;deepsearch_tool&quot;: {&quot;tool_name&quot;: &quot;deepsearch_tool&quot;, &quot;arguments&quot;: {&quot;query&quot;: &quot;str&quot;, &quot;max_chapters&quot;: &quot;4&quot;, &quot;max_paragraphs_per_chapter&quot;: &quot;5&quot;, &quot;max_critical_queries&quot;: &quot;3&quot;, &quot;max_revisions&quot;: &quot;1&quot;}, &quot;return&quot;: &quot;str&quot;, &quot;docstring&quot;: &quot;Invoke deepsearch to deeply analyze the query and generate a more detailed response.&quot;, &quot;dependencies&quot;: [&quot;os&quot;, &quot;re&quot;, &quot;typing&quot;, &quot;pydantic&quot;, &quot;dotenv&quot;, &quot;langgraph&quot;, &quot;langchain_core&quot;, &quot;langchain_together&quot;, &quot;tavily&quot;], &quot;module_path&quot;: &quot;vinagent.tools.deepsearch&quot;, &quot;tool_type&quot;: &quot;module&quot;, &quot;tool_call_id&quot;: &quot;tool_f5568b04-72fe-4885-8494-3f8c121729ba&quot;}, &quot;query_similar_legal_cases&quot;: {&quot;tool_name&quot;: &quot;query_similar_legal_cases&quot;, &quot;arguments&quot;: {&quot;n_legal_cases&quot;: 2, &quot;threshold&quot;: 0.6}, &quot;return&quot;: &quot;The similar legal cases.&quot;, &quot;docstring&quot;: &quot;Query the similar legal cases to the given query.\\n    Args:\\n        query (str): The query string.\\n        n_legal_cases (int): The number of legal cases\\n        threshold (float): The similarity threshold. Defaults to 0.6.\\n    Returns:\\n        The similar legal cases.&quot;, &quot;dependencies&quot;: [&quot;pandas&quot;, &quot;datasets&quot;, &quot;pathlib&quot;, &quot;langchain_core&quot;, &quot;langchain.text_splitter&quot;, &quot;langchain_huggingface&quot;, &quot;aucodb&quot;, &quot;vinagent&quot;], &quot;module_path&quot;: &quot;vinagent.tools.search_legal_cases&quot;, &quot;tool_type&quot;: &quot;module&quot;, &quot;tool_call_id&quot;: &quot;tool_331a2f3a-8bc9-454a-89b3-2ad3c8ac074e&quot;}}\n\n- User: unknown_user\n------------------------\nInstructions:\n- Let\&#39;s answer in a natural, clear, and detailed way without providing reasoning or explanation.\n- If user used I in Memory, let\&#39;s replace by name unknown_user in User part.\n- You need to think about whether the question need to use Tools?\n- If it was daily normal conversation. Let\&#39;s directly answer as a human with memory.\n- If the task requires a tool, select the appropriate tool with its relevant arguments from Tools list according to following format (no explanations, no markdown):\n{\n&quot;tool_name&quot;: &quot;Function name&quot;,\n&quot;tool_type&quot;: &quot;Type of tool. Only get one of three values [&quot;function&quot;, &quot;module&quot;, &quot;mcp&quot;]&quot;\n&quot;arguments&quot;: &quot;A dictionary of keyword-arguments to execute tool_name&quot;,\n&quot;module_path&quot;: &quot;Path to import the tool&quot;\n}\n- Let\&#39;s say I don\&#39;t know and suggest where to search if you are unsure the answer.\n- Not make up anything.\n&#39;, additional_kwargs={}, response_metadata={}),
 AIMessage(content=&#39;{&quot;tool_name&quot;: &quot;search_api&quot;, &quot;tool_type&quot;: &quot;module&quot;, &quot;arguments&quot;: {&quot;query&quot;: &quot;legal case sales tax exemption claimed&quot;}, &quot;module_path&quot;: &quot;vinagent.tools.websearch_tools&quot;}&#39;, additional_kwargs={&#39;refusal&#39;: None}, response_metadata={&#39;token_usage&#39;: {&#39;completion_tokens&#39;: 513, &#39;prompt_tokens&#39;: 1000, &#39;total_tokens&#39;: 1513, &#39;completion_tokens_details&#39;: {&#39;accepted_prediction_tokens&#39;: 0, &#39;audio_tokens&#39;: 0, &#39;reasoning_tokens&#39;: 448, &#39;rejected_prediction_tokens&#39;: 0}, &#39;prompt_tokens_details&#39;: {&#39;audio_tokens&#39;: 0, &#39;cached_tokens&#39;: 0}}, &#39;model_name&#39;: &#39;o4-mini-2025-04-16&#39;, &#39;system_fingerprint&#39;: None, &#39;finish_reason&#39;: &#39;stop&#39;, &#39;logprobs&#39;: None}, id=&#39;run--a3551d66-37ba-4685-91b1-9954cb8e917e-0&#39;, usage_metadata={&#39;input_tokens&#39;: 1000, &#39;output_tokens&#39;: 513, &#39;total_tokens&#39;: 1513, &#39;input_token_details&#39;: {&#39;audio&#39;: 0, &#39;cache_read&#39;: 0}, &#39;output_token_details&#39;: {&#39;audio&#39;: 0, &#39;reasoning&#39;: 448}}),
 ToolMessage(content=&quot;Completed executing module tool search_api({&#39;query&#39;: &#39;legal case sales tax exemption claimed&#39;})&quot;, tool_call_id=&#39;tool_f0647aec-0361-4791-9f05-ffa05f2d9f98&#39;, artifact=&quot;Sales tax exemptions were claimed in various legal cases, including a Mississippi case about medical devices and a Missouri case about electronic price scanners. The Supreme Court struck down a Texas statute exempting religious publications from sales tax. Nonprofits&#39; tax exemptions were also challenged.&quot;)]
</code></pre></div>
<p>The history only returns a list of messages ending with ToolMessage. If you want the Agent to modify the ToolMessage according to human preferences, set <code>is_tool_formatted=True</code>.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">message</span> <span class="o">=</span> <span class="n">legal_agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>    <span class="s2">&quot;Let find one legal case claimed exemption sales tax&quot;</span><span class="p">,</span> 
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>    <span class="n">is_tool_formatted</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>    <span class="n">max_history</span><span class="o">=</span><span class="mi">1</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="p">)</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="n">message</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>INFO:vinagent.agent.agent:Tool calling iteration 1/10
INFO:vinagent.agent.agent:Executing tool call: {&#39;tool_name&#39;: &#39;search_api&#39;, &#39;tool_type&#39;: &#39;module&#39;, &#39;arguments&#39;: {&#39;query&#39;: &#39;legal case claimed exemption sales tax&#39;}, &#39;module_path&#39;: &#39;vinagent.tools.websearch_tools&#39;}
INFO:vinagent.register.tool:Completed executing module tool search_api({&#39;query&#39;: &#39;legal case claimed exemption sales tax&#39;})
INFO:vinagent.agent.agent:Tool calling iteration 2/10

AIMessage(content=&#39;One prominent example is Texas Monthly, Inc. v. Bullock, 489 U.S. 1 (1989).  In that case Texas Monthly challenged a state statute that exempted from sales tax only those periodicals devoted exclusively to religious or public affairs.  The U.S. Supreme Court held the exemption unconstitutional under the Establishment Clause.&#39;, additional_kwargs={&#39;refusal&#39;: None}, response_metadata={&#39;token_usage&#39;: {&#39;completion_tokens&#39;: 536, &#39;prompt_tokens&#39;: 1061, &#39;total_tokens&#39;: 1597, &#39;completion_tokens_details&#39;: {&#39;accepted_prediction_tokens&#39;: 0, &#39;audio_tokens&#39;: 0, &#39;reasoning_tokens&#39;: 448, &#39;rejected_prediction_tokens&#39;: 0}, &#39;prompt_tokens_details&#39;: {&#39;audio_tokens&#39;: 0, &#39;cached_tokens&#39;: 0}}, &#39;model_name&#39;: &#39;o4-mini-2025-04-16&#39;, &#39;system_fingerprint&#39;: None, &#39;finish_reason&#39;: &#39;stop&#39;, &#39;logprobs&#39;: None}, id=&#39;run--a501aa03-3411-4b44-9a11-440bb9c25273-0&#39;, usage_metadata={&#39;input_tokens&#39;: 1061, &#39;output_tokens&#39;: 536, &#39;total_tokens&#39;: 1597, &#39;input_token_details&#39;: {&#39;audio&#39;: 0, &#39;cache_read&#39;: 0}, &#39;output_token_details&#39;: {&#39;audio&#39;: 0, &#39;reasoning&#39;: 448}})
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">legal_agent</span><span class="o">.</span><span class="n">in_conversation_history</span><span class="o">.</span><span class="n">get_history</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>[SystemMessage(content=&#39;A legal assistant who can find the similar legal cases\nHere is your skills:\n- search similar legal cases- summary the legal cases- extract the main entities in the legal cases- search information on the internet&#39;, additional_kwargs={}, response_metadata={}),
 HumanMessage(content=&#39;You are given a task, ...&#39;),
 AIMessage(content=&#39;Here are some of the main ethical considerations ...&#39;),
 SystemMessage(content=&#39;A legal assistant who can find the similar legal cases ...&#39;),
 HumanMessage(content=&#39;You are given a task, a list of available tools ...&#39;),
 AIMessage(content=&#39;{&quot;tool_name&quot;: &quot;search_api&quot;, &quot;tool_type&quot;: &quot;module&quot;, &quot;arguments&quot;: {&quot;query&quot;: &quot;legal case claimed exemption sales tax&quot;}, &quot;module_path&quot;: &quot;vinagent.tools.websearch_tools&quot;}&#39;),
 ToolMessage(content=&quot;Completed executing module tool search_api()...&quot;),
 SystemMessage(content=&#39;A legal assistant who can find the similar legal cases\nHere is your skills:\n- search similar legal cases- summary the legal cases- extract the main entities in the legal cases- search information on the internet&#39;),
 HumanMessage(content=&#39;You are given a task, a list of available tools...&#39;),
 AIMessage(content=&#39;One prominent example is Texas Monthly, Inc. v. Bullock, 489 U.S. 1 (1989).  In that case Texas Monthly challenged a state statute that exempted from sales tax only those periodicals devoted exclusively to religious or public affairs.  The U.S. Supreme Court held the exemption unconstitutional under the Establishment Clause.&#39;)]
</code></pre></div>
<p>By default, VinAgent’s agent can store up to the last 10 messages in its conversation history. Therefore, if we continue the query, the list of answers will be appended to the existing history and the most old message will be popped out according to FIFO (first in first out). In this case, if you choose to modify the tool result, you will receive an <code>AIMessage</code> as the last message.</p>
<h2 id="summarize-legal-case">Summarize legal case<a class="headerlink" href="#summarize-legal-case" title="Permanent link">&para;</a></h2>
<p>With very long legal cases, we cannot capture each event in detail. Therefore, we need to summarize the legal case in a short form to accelerate attorneys’ reading speed. Let's test summary with legal case 199<sup>th</sup>.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">legal_case</span> <span class="o">=</span> <span class="n">docs</span><span class="p">[</span><span class="mi">199</span><span class="p">]</span><span class="o">.</span><span class="n">page_content</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="n">message</span> <span class="o">=</span> <span class="n">legal_agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Let&#39;s summarize this legal case in 200 words including context, development, plaintiff&#39;s arguments, and court ruling </span><span class="se">\n</span><span class="si">{</span><span class="n">legal_case</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_history</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>INFO:vinagent.agent.agent:No authentication card provided, skipping authentication
INFO:vinagent.agent.agent:I&#39;am chatting with unknown_user
INFO:vinagent.agent.agent:Tool calling iteration 1/10
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions &quot;HTTP/1.1 200 OK&quot;
INFO:vinagent.agent.agent:No more tool calls needed. Completed in 1 iterations.
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>This case centers on the legal framework governing a Development Consent Order (DCO) for Heathrow Airport Ltd’s (HAL) proposal to build a third runway (the North-West Runway, NWR). Successive UK governments and the independent 2012 Airports Commission concluded that additional airport capacity in southeast England was needed by 2030. After extensive public and expert consultation, the Government issued a draft National Policy Statement (NPS) under the Planning Act 2008, culminating in the Airports NPS (ANPS) in June 2018. Objectors—Friends of the Earth and Plan B Earth—claimed the Secretary of State unlawfully ignored the Paris Agreement’s temperature targets, failed to explain how the ANPS aligned with Government climate policy (section 5(8)), lacked proper regard for climate change mitigation (section 10), and breached the Strategic Environmental Assessment Directive by omitting non-CO₂ impacts and post-2050 emissions. The Divisional Court refused permission, finding the Secretary of State had rationally relied on the Climate Change Act 2008 and expert advice from the Committee on Climate Change. The Court of Appeal overturned that decision, declaring the ANPS legally ineffective. HAL then appealed to the Supreme Court, which allowed HAL’s appeal. The Supreme Court held that neither the Paris Agreement nor unquantified non-CO₂ or post-2050 emissions were “obviously material” legal requirements at the policy-setting stage and that the ANPS had lawfully discharged statutory duties.
</code></pre></div>
<h2 id="timeline-and-fact-organization">Timeline and Fact Organization<a class="headerlink" href="#timeline-and-fact-organization" title="Permanent link">&para;</a></h2>
<p>We can organize the timeline of events for each legal case in reverse chronological order to enhance tracking efficiency. This allows an attorney to review the event sequence based on the timeline to identify key developments in the lawsuit. This approach is especially valuable for lengthy and complex legal cases, where recalling every minor event is essential.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">message</span> <span class="o">=</span> <span class="n">legal_agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Let&#39;s create a timeline of events in this legal case in descending order: </span><span class="se">\n</span><span class="si">{</span><span class="n">legal_case</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_history</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>INFO:vinagent.agent.agent:No authentication card provided, skipping authentication
INFO:vinagent.agent.agent:I&#39;am chatting with unknown_user
INFO:vinagent.agent.agent:Tool calling iteration 1/10
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions &quot;HTTP/1.1 200 OK&quot;
INFO:vinagent.agent.agent:No more tool calls needed. Completed in 1 iterations.
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Here is a descending‐order timeline of the key events in the Heathrow 3rd-runway/NPS litigation and its policy background:

• 25 June 2020  
  – Committee on Climate Change publishes its 2020 Progress Report recommending inclusion of international aviation and shipping in the UK’s net-zero targets and urging review of airport capacity strategy in light of COVID-19 and net zero.

• 26 June 2019  
  – The Climate Change Act 2008 (2050 Target Amendment) Order 2019 comes into force, amending section 1 of the CCA 2008 to require a 100% reduction in net UK carbon emissions by 2050 (i.e. “net zero”).

• 25 June 2019  
  – Parliament declares a “climate and environmental emergency.”  
  – On 26 June, the CCC’s report “Net Zero: The UK’s contribution to stopping global warming” is published, advising urgent statutory adoption of net-zero greenhouse gas targets by 2050 (including international aviation/shipping).

• 24 September 2019  
  – CCC writes to the Secretary of State for Transport recommending formal inclusion of international aviation and shipping in the UK’s net-zero statutory targets.

• May 2019 ([2019] EWHC 1070 (Admin); [2019] EWHC 1069 (Admin))  
  – The Divisional Court (Hickinbottom LJ &amp; Holgate J) hears the rolled-up claims and dismisses all challenges to the designation of the Airports NPS (ANPS).

• 26 February 2020 ([2020] EWCA Civ 214)  
  – Court of Appeal allows the Friends of the Earth and Plan B Earth appeals, declares the ANPS unlawful and of no legal effect for failure to take the Paris Agreement properly into account.

• February 2017  
  – Department for Transport launches first public consultation on a draft Airports National Policy Statement (ANPS) for the northwest-runway (NWR) scheme.

• October 2017  
  – Second round of consultation on the draft ANPS is opened (large numbers of responses received).

• 1 November 2017  
  – Transport Committee publishes its report on the proposed NWR scheme; Government later issues a formal response in June 2018.

• June 2018  
  – DfT publishes its responses to both rounds of ANPS consultation and to the Transport Committee report.

• 5 June 2018  
  – Secretary of State lays the final version of the ANPS before Parliament, together with its Sustainability Appraisal (the SEA/AA reports).

• 25 June 2018  
  – House of Commons debates and votes to approve the ANPS (415 to 119).

• 26 June 2018  
  – Secretary of State formally designates the Airports NPS under section 5(1) of the Planning Act 2008.

• Late June–July 2018  
  – Objectors (including Friends of the Earth and Plan B) issue claims for judicial review under section 13 of the Planning Act 2008, challenging the lawfulness of the ANPS designation.

• 14 June 2018  
  – CCC Chair (Lord Deben) and Deputy Chair (Baroness Brown) write to the Transport Secretary expressing surprise that the ANPS did not refer to the CCA 2008 targets or the Paris Agreement.

• 5 June 2018 (same day as laying the ANPS)  
  – Cabinet sub-committee paper confirms the government will address aviation emissions in its forthcoming Aviation Strategy; notes current uncertainty over carbon-budget treatment of international aviation.

• 17 April 2018  
  – At the Commonwealth Heads of Government Meeting, UK announces it will seek CCC advice on Paris Agreement implications once the IPCC’s 1.5 °C report is published.

• December 2017  
  – DfT publishes “Beyond the Horizon: The Future of UK Aviation – Next Steps,” setting out how the forthcoming Aviation Strategy will address both CO₂ and non-CO₂ aviation climate impacts.

• October 2016  
  – CCC publishes advice (“UK Climate Action following the Paris Agreement”) confirming that existing UK targets remain appropriate for now and advising they be kept under review.

• 14 March &amp; 24 March 2016  
  – Ministers in the House of Commons state that the UK intends to enshrine a “net-zero” Paris goal in domestic law but that the questions of “how” remain to be answered.

• 22 April 2016  
  – United Kingdom signs the Paris Agreement.

• 17 November 2016  
  – United Kingdom ratifies the Paris Agreement.

• 25 October 2016  
  – Transport Secretary announces the north-west-runway (NWR) option as the government’s preferred scheme for Heathrow expansion.

• 12 December 2015  
  – Paris Agreement text is agreed at COP 21.

• 14 December 2015  
  – Transport Secretary announces the government will proceed via a national policy statement (NPS) under the Planning Act 2008 and that further work on environmental impacts (including carbon) is required.

• 1 July 2015  
  – Airports Commission publishes its Final Report, selecting the northwest-runway (NWR) option as its “preferred” solution (subject to mitigation).

• 17 December 2013  
  – Airports Commission publishes its Interim Report, concluding that one new runway is needed by 2030 and assessing options under a carbon-trading cap consistent with a 2 °C goal.

• 2012  
  – Airports Commission is established under Sir Howard Davies to review UK airport capacity and recommend a scheme.

• 26 November 2008 (approx.)  
  – Climate Change Act 2008 and Planning Act 2008 are enacted on the same day, creating the framework for UK carbon targets, carbon budgets and a new nationally significant infrastructure consenting regime (via NPSs and DCOs).

• 1992  
  – United Nations Framework Convention on Climate Change is adopted, laying the foundation for later climate treaties (including Kyoto and Paris).
</code></pre></div>
<h2 id="argument-analysis">Argument analysis<a class="headerlink" href="#argument-analysis" title="Permanent link">&para;</a></h2>
<p>Sometimes, attorney needs dive deepth to understand the strength and weakness of appellants' arguments. This is to ensure they can increase the probability of win before the trial begins. legal_agent can also deeply analyze the strength and weakness. This process involves evaluating evidence, legal precedents, and potential counterarguments to build a robust strategy.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">message</span> <span class="o">=</span> <span class="n">legal_agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Let&#39;s analyze the strengths and weaknesses of appellants&#39; arguments: </span><span class="se">\n</span><span class="si">{</span><span class="n">legal_case</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_history</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>INFO:vinagent.agent.agent:No authentication card provided, skipping authentication
INFO:vinagent.agent.agent:I&#39;am chatting with unknown_user
INFO:vinagent.agent.agent:Tool calling iteration 1/10
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions &quot;HTTP/1.1 200 OK&quot;
INFO:vinagent.agent.agent:No more tool calls needed. Completed in 1 iterations.
</code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Below is a concise appraisal of the four principal grounds on which Heathrow Airport Ltd (HAL) (together with the Secretary of State) challenged the Court of Appeal’s decision invalidating the Airports National Policy Statement (ANPS).  For each ground I identify what I see as the chief strengths of HAL’s position and the major vulnerabilities in FoE/Plan B’s counter-arguments.

1. Ground (i): Section 5(8) PA 2008 – “Duty to explain how the NPS takes account of Government climate policy”  
   HAL’s argument  
   • Parliament fixed the UK’s carbon-reduction commitment in the Climate Change Act 2008.  That target (80 % by 2050, later 100 %) and the process for adjusting it are entrenched in statute.  The ANPS properly explained how it took that settled policy into account (paras 5.71–5.73).  Anything beyond that—e.g. aspirational global temperature goals in the Paris Agreement—was not “Government policy” in the sense of an established, unqualified domestic statement of policy.  
   Strengths  
   – Textual: section 5(8) looks to “Government policy” already laid down.  Treaties in force but not given domestic effect—and ministerial utterances that flag only an intention to return to Parliament later—do not qualify.  
   – Context and purpose: NPS explanations must avoid endless trawls through speeches, consultation responses or emerging international commitments.  They must stick to clear, binding domestic policy statements.  
   Weaknesses for FoE/Plan B  
   – They relied on loose ministerial remarks in early 2016 and on the Paris Agreement’s temperature goal.  Those neither created binding UK law nor amounted to an unqualified Government policy of the kind that section 5(8) demands.  
   – Invoking aspirational treaty aims would impose a burden on NPS drafters to catalogue every “policy” mention in White Papers, Commons Statements, press releases, etc., leading to unpredictability.

2. Ground (ii): Section 10 PA 2008 – “Have regard to mitigation/adaptation”  
   HAL’s argument  
   • Section 10 requires the Secretary of State to aim for sustainable development, including mitigating/adapting to climate change, but gives a broad margin of judgment as to which material considerations to weigh and the weight to give them.  The ANPS addressed the UK’s binding obligations under the Climate Change Act, which already give effect to the Paris Agreement NDCs.  The Paris Agreement itself is not extra domestic law and needed no separate treatment.  
   Strengths  
   – Well-settled Wednesbury principle: dehors express statutory direction, a decision-maker need not catalogue every possible international commitment.  Unless omission is irrational, it is lawful.  
   – The ANPS did address greenhouse gases, carbon budgets, and required that any DCO application demonstrate consistency with whatever targets applied at that later date.  
   Weaknesses for FoE/Plan B  
   – Their approach conflated international treaty goals with domestic law obligations.  They could not show that the Secretary of State’s refusal even arguable lacked “reasonableness” or was outside his wide discretion.  
   – To impose a free-standing duty to re-examine global aims would overstep parliament’s careful design of carbon-budget review processes in the 2008 Act.

3. Ground (iii): SEA Directive – “Adequacy of the Environmental Report”  
   HAL’s argument  
   • The strategic environmental assessment (SEA) for the draft ANPS took the Airports Commission’s extensive work (including all carbon scenarios) as its baseline.  It quantified CO₂ and recorded that non-CO₂ effects were uncertain and could not yet be sensibly modelled.  Under Articles 5(2)–(3) SEA (and transposing regs), the Secretary of State had a broad discretion to decide what “reasonably may be required” in an environmental report.  The public was consulted and responses on climate matters were taken into account.  
   Strengths  
   – Blewett/Wednesbury standard: environmental reports need only supply a sufficient basis for public consultation, not endless academic coverage of every hypothetical.  
   – The public consultation process did solicit comments on climate goals; the report and ANPS responded.  
   Weaknesses for FoE/Plan B  
   – Their claim rested on a judicial curiosity—that the Paris Agreement should have been named in the scoping list.  But law and policy on aviation emissions were evolving; the report explained clearly why non-CO₂ effects were deferred for future, more detailed work.  
   – Under EU law as under domestic law, the SEA Directive tolerates an iterative and proportionate approach.

4. Ground (iv): Section 10(3) PA 2008 – “Post-2050 and Non-CO₂ Emissions”  
   HAL’s argument  
   • The ANPS (and its AoS) modelled airport emissions through 2085/86 and quantified all CO₂ emissions (pre- and post-2050).  They explained that post-2050 policy settings and future carbon budgets would govern any DCO, and that non-CO₂ climate impacts are scientifically uncertain and not yet regulated.  Those matters will be addressed in the forthcoming Aviation Strategy and at the DCO stage.  It was neither irrational nor procedurally defective to defer them.  
   Strengths  
   – The ANPS spelled out the requirement that any DCO applicant show consistency with “then current” targets.  There is a built-in safety valve (section 104 PA 2008) permitting refusal if future obligations would be breached.  
   – Reasonable scientific uncertainty about non-CO₂ forcings, and absence of an agreed metric, justified a focused CO₂ assessment now and detailed post-2030 work later.  
   Weaknesses for FoE/Plan B  
   – Invoking a notional “net zero” objective for post-2050 emissions would have required guesses about legislation not yet in place.  That cannot render a policy statement unlawful.  
   – Their critique collapses into an argument for pre-deciding a DCO refusal point far in advance of any application, blurring the line between NPS-making and DCO decision-making.

Overall conclusion  
   HAL’s key legal strength across all grounds is that Parliament deliberately embedded UK carbon commitments in the Climate Change Act framework, prescribing a process for adjusting them.  Neither the Paris Agreement’s aspirational temperature goals nor emerging Aviation Strategy work constituted binding domestic policy or mandatory inputs at the NPS-making stage.  The courts below (Divisional Court, then Sup Ct on appeal) correctly recognized the broad discretion and margin of judgment that the PA 2008 and SEA regime afford to decision-makers on these complex, evolving climate issues.
</code></pre></div>
<h2 id="jurisdictional-analysis">Jurisdictional Analysis<a class="headerlink" href="#jurisdictional-analysis" title="Permanent link">&para;</a></h2>
<p>Jurisdictional analysis is vital in legal proceedings to ensure challenges are pursued correctly and efficiently. It serves to identify the correct legal framework, ensure compliance with time limits, define the scope of review, clarify court hierarchy and appeal routes, guide remedies and outcomes, and align with statutory interplay. By addressing these aspects, jurisdictional analysis prevents procedural errors, focuses arguments on permissible legal grounds, and informs strategic decisions, thereby upholding the integrity of the judicial process.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">message</span> <span class="o">=</span> <span class="n">legal_agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Let&#39;s analyze the jurisdictional analysis: </span><span class="se">\n</span><span class="si">{</span><span class="n">legal_case</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_history</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>INFO:vinagent.agent.agent:Tool calling iteration 1/10
The challenge to the Secretary of State’s designation of the Airports National Policy Statement (ANPS) went through the courts not by way of ordinary appeal but by judicial review under the Planning Act 2008 and the Senior Courts Act 1981.  The jurisdictional framework can be broken down as follows:

1.   Statutory basis for challenge (PA 2008 s 13)  
     –  Section 13(1) of the Planning Act 2008 provides the *only* route by which an NPS may be questioned in the courts: by way of a claim for judicial review.  
     –  It must be brought within six weeks from the later of (a) the date of designation of the NPS or (b) its publication.

2.   Procedural history  
     –  Objectors (Friends of the Earth, Plan B Earth and others) filed judicial review proceedings in the High Court challenging the Secretary of State’s decision under s 5(1) to designate the ANPS.  
     –  The Divisional Court (Hickinbottom LJ and Holgate J) heard all of the claims on a “rolled-up” basis (i.e. permission and merits together) and dismissed every ground.  
     –  The objectors appealed under the statutory right of appeal from a JR decision to the Court of Appeal.  That court allowed two of the grounds, quashed the designation, and said the ANPS was of no legal effect unless and until remedial steps were taken.  
     –  Heathrow Airport Ltd (HAL) (joined as an interested party below) then obtained permission to appeal to the Supreme Court under s 40(1) of the Constitutional Reform Act 2005.

3.   Scope of judicial review jurisdiction  
     –  Subject-matter jurisdiction: only the lawfulness of the NPS designation itself (and the procedures leading up to it) could be reviewed, not the merits of airport expansion or technical climate policy.  
     –  Time limit: six weeks under PA 2008 s 13(1).  
     –  Remedies: the court can quash the designation or grant declarations (but not award damages).  The Secretary of State could then (and still can) choose to re-designate the ANPS after remedying any procedural or legal defects.

4.   Relationship to other statutory provisions  
     –  Senior Courts Act 1981 s 31 gives the High Court (and Divisional Court) general JR jurisdiction; PA 2008 s 13 is a carve-out stipulating the subject and time limit for NPS challenges.  
     –  No ordinary “appeal” lies against an NPS under PA 2008 s 9—only JR under s 13.  
     –  Once an NPS is in force, applications for Development Consent Orders under PA 2008 Part 6 must be determined “in accordance with” the NPS (s 104), subject to limited exceptions.

5.   Final leave and outcome  
     –  HAL, as an interested party with a substantial investment in the NWR proposal, was granted leave to defend the validity of the ANPS in the Supreme Court.  
     –  The Supreme Court’s ultimate task is purely to resolve the legal questions of statutory interpretation and public-law review raised by the appeal.

In short, the courts’ jurisdiction in this case sprang from the Planning Act’s carefully circumscribed JR regime for national policy statements (PA 2008 s 13), carried through the Divisional Court, Court of Appeal and now the Supreme Court, with all stakeholders bound by the six-week time bar and limited to questions of law and procedure.
</code></pre></div>
<h2 id="ethical-and-bias-in-court-ruling">Ethical and Bias in court ruling<a class="headerlink" href="#ethical-and-bias-in-court-ruling" title="Permanent link">&para;</a></h2>
<p>Court rulings need to be ethical and free from bias to deliver fair, open, and responsible decisions, especially in tricky cases while many unfair judgements were made. It’s about ensuring justice for future generations, weighing economic gains against environmental and local community impacts, being transparent, handling scientific unknowns carefully, avoiding institutional blind spots, and striking the right balance in judicial oversight. If courts don’t tackle these ethical and bias issues head-on, they risk deepening inequalities, weakening environmental protections, and losing the public’s trust in the system.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">message</span> <span class="o">=</span> <span class="n">legal_agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Let&#39;s consider the ethical and bias arguments of court ruling for this legal case: </span><span class="se">\n</span><span class="si">{</span><span class="n">legal_case</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">max_history</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>INFO:vinagent.agent.agent:Tool calling iteration 1/10


Here are some of the main ethical considerations and potential bias-related issues raised by the courts’ treatment of the third-runway policy statement (ANPS) for Heathrow:

1. Intergenerational and global justice  
•   Duty to future generations:  Expanding Heathrow locks in additional carbon emissions for decades. Ethically, do today’s beneficiaries have a right to harness fossil-fuel aviation capacity at the expense of young people and unborn generations bearing the climate cost?  
•   “Common but differentiated responsibility”:  The UK has among the stricter legally binding climate targets. There is a moral question whether it ought to go beyond its 2050 carbon ceiling (and take non-CO₂ effects into account) so as to set a leadership example globally.

2. Weighing economic gains vs. environmental harms  
•   Distributional impact on local communities:  The project will bring noise, air pollution and property blight to residents under flight paths. An ethical analysis probes whether their health and quality-of-life costs have been fairly balanced against national GDP growth and passenger convenience.  
•   Procedural fairness:  Did the consultation and environmental assessment processes genuinely empower affected communities to shape or challenge the policy, or were they a box-ticking exercise that privileged central government’s economic case?

3. Transparency and reason-giving  
•   Climate rationale omitted:  The Court of Appeal found the Secretary of State failed to explain how the ANPS policy aligned with the Paris goals; the Supreme Court later said that omission did not cross the threshold of irrationality. Ethically, stakeholders argue the public deserves an explicit account of how airport expansion sits alongside the U.K.’s broader commitments to limit warming to “well below 2 °C.”  
•   Trust in expert advice:  Relying heavily on the Airports Commission and the Committee on Climate Change can seem to bias decision-making toward technical or economic expertise while sidelining lay and community values around environmental precaution.

4. Use of the precautionary principle vs. innovation optimism  
•   Precautionary stance:  Some ethicists argue that “scientific uncertainty” over non-CO₂ impacts and post-2050 emissions should have triggered a precautionary moratorium until tighter metrics and policies were in place.  
•   Innovation and efficiency view:  Government and HAL contend that technology improvements (more fuel-efficient aircraft, carbon trading, sustainable aviation fuels) will allow capacity growth without breaching climate targets—an ethically forward-looking, solution-driven stance.

5. Institutional and cognitive biases  
•   Status-quo momentum (“path-dependency”):  Heathrow has long been a focal point of U.K. aviation policy. Ethically, decision-makers may be unduly anchored to existing infrastructure and past studies rather than re-evaluating fundamental climate and social trade-offs.  
•   Framing and risk perception:  By characterizing carbon emissions as “not a reason to refuse consent unless material,” the ANPS frames climate risk as secondary, which can bias assessments against deeply weighting environmental uncertainties.

6. Judicial deference vs. rights-protecting oversight  
•   Deference to political branches:  The Supreme Court majority accepted that the Secretary of State’s policy judgments—even if contestable—were not irrational. Some critics see this as ethically problematic deference that weakens environmental accountability.  
•   Activist impulse:  Conversely, the Court of Appeal’s willingness to quash the ANPS for failure to expressly link to Paris raised questions about the proper reach of judicial review and the democratic mandate of Parliamentarians who voted in support.

In sum, this ruling sits at the intersection of competing ethical claims—economic growth and social opportunity versus climate justice and community well-being—and highlights how technical advice, statutory formulations and institutional roles can introduce biases in how those claims are weighed.
</code></pre></div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../paper_research/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Research Agent">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Research Agent
              </div>
            </div>
          </a>
        
        
          
          <a href="../customer_care/" class="md-footer__link md-footer__link--next" aria-label="Next: Customer Care Multi-Agent">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Customer Care Multi-Agent
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 DataScienceWorld.Kan, Inc | <a href="#__consent">Consent Preferences</a>

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.code.copy", "announce.dismiss", "content.code.annotate", "content.code.select", "content.tabs.link", "content.action.edit", "content.tooltips", "toc.follow", "navigation.indexes", "navigation.expand", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.footer", "navigation.path", "navigation.prune", "navigation.tracking", "search.highlight", "search.share", "search.suggest"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>